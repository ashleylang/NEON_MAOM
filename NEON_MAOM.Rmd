---
title: 'Patterns in mineral-associated organic matter across scales: untangling the
  influence of climate, mineralogy and mycorrhizal fungi on soil carbon stabilization'
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r packages, include=FALSE}
library(tidyverse)
library(cowplot)
library(ggmap)
library(maps)
library(mapdata)
library(nlme) #lme
library(neonUtilities)
library(sjPlot)
library(dotwhisker)
library(lme4) #lmer
library(car)
library(ggpubr)
library(ggrepel)
library(ggeffects)
library(WorldFlora)
library(viridis)
data(vascular.families)
 library(MuMIn)
```

```{r setup, include=F}
#Identify study sites
forests=c("BART","DELA","HARV","ORNL","TREE","LENO", "SERC")

#Get climate data for each site:
site_clim=read.csv("NEON_Field_Site_Metadata_20201204.csv") %>% 
  select(field_site_id, field_mean_annual_temperature_C, field_mean_annual_precipitation_mm, field_domint_plant_species) %>% 
  rename(Site=field_site_id) %>%
  filter(Site %in% forests)

CDI=read.csv("CDI.csv")

site_lats=read.csv("NEON_Field_Site_Metadata_20201204.csv") %>% 
  select(field_site_id, field_latitude, field_longitude)

#create list of samples received from Biorepository 
received_sampleID=read.csv("Samples_received.csv") %>%
  select(sampleID) %>% 
  mutate(sampleID = substr(sampleID,1,nchar(sampleID)-3))

sampleIDs=received_sampleID$sampleID

#Radiocarbon calculations
#decay constant
lambda=1/8267

radiocarbon=read.csv("NEON_14C_data.csv") %>% 
  mutate(yr="2021") %>%  #collection date
 separate(Sample, into=c("Site", "Plot", "fraction")) %>% 
  unite(col=plotID, c(Site, Plot), sep="_", remove=F) %>% 
  mutate(decayRate=(fractionModern*lambda)/(1-fractionModern),
         turnoverTime=1/decayRate) #Calculating decomposition rate of the C. For details about the derivation of this formula see Trumbore et al. (2016).

#Density fractionation data: This spreadsheet has been manually updated with EA re-runs from EHP on April 7 2021. 
CN_data=read.csv("SOM_Fractions_CN.csv") %>% 
  separate(Sample.ID, into=c("Site", "Plot", "fraction")) %>% 
  mutate(Site = str_replace(Site, "ORLN", "ORNL")) %>% 
  unite(col="Sample.ID",c(Site, Plot), sep="_") %>% 
  filter(Sample.ID != "STANDARD_FILTER") %>% 
  select(-Count)

#just the rows with samples not run for d13c:
# missing_samples=CN_data %>% 
#   filter(grepl("ORNL", Sample.ID) | Sample.ID=="DELA_001") %>% 
#   filter(fraction=="HF")
# 

#checking if model results change when other HF CN data are used
# other_CN=read.csv("Lang_NEON_d13c_MAOM.csv") %>% 
#   select(ID, N..., C..., sample.weight..mg.) %>% 
#   separate(ID, into=c("Site", "Plot", "fraction")) %>% 
#   drop_na() %>% 
#   unite(col="Sample.ID",c(Site, Plot), sep="_") %>% 
#   mutate(C.N=C.../N...) %>% 
#   rename("pct.C"=C..., "pct.N"= N..., "Sample.mass"=sample.weight..mg.) %>% 
#   rbind(missing_samples)
# 

#Setting up lists for later binding/filtering
plots=unique(CN_data$Sample.ID)

HF_mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
   select(Sample.ID, HF.mass..mg.) 

HF_CN=read.csv("SOM_Fractions_CN.csv") %>%
  separate(Sample.ID, into=c("Site", "Plot", "fraction")) %>%
  dplyr::mutate(Site = str_replace(Site, "ORLN", "ORNL")) %>% #fixing typos
  dplyr::filter(Site != "STANDARD",
          fraction == "HF") %>%
   dplyr::select(-Count) %>%
  unite(col="Sample.ID",c(Site, Plot), sep="_") %>%
  rename(pct.C.soil=pct.C, pct.N.soil=pct.N) %>% 
  left_join(HF_mass, by="Sample.ID") %>% 
  rename(soil=HF.mass..mg.)

total.fractions.mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, Total.fractions.mass)

total.soil.mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, mg.total.soil..aim.5000.)

total.C=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, FLF.filter.air.dry.mass..mg., oLF.filter.air.dry.mass..mg., fLF.mass..mg., oLF.mass..mg.) %>% 
  rename(FLF.filter=FLF.filter.air.dry.mass..mg.,OLF.filter=oLF.filter.air.dry.mass..mg., FLF.soil=fLF.mass..mg., 
         OLF.soil=oLF.mass..mg. ) %>% 
  pivot_longer(!Sample.ID, names_to="component", values_to="mass") %>% 
  separate(component, into=c("fraction", "component")) %>% 
  pivot_wider(names_from=component, values_from=mass) %>% 
  mutate(prop.soil=(soil/(soil+filter))) %>% 
  left_join(CN_data, by=c("Sample.ID", "fraction")) %>%
  select(-C.N) %>% 
  mutate(mg.C.tin=((pct.C/100)*Sample.mass),
         mg.N.tin=((pct.N/100)*Sample.mass),
         mg.soil.tin=(prop.soil*Sample.mass)) %>% 
  mutate(pct.C.soil=(mg.C.tin/mg.soil.tin)*100,
         pct.N.soil=(mg.N.tin/mg.soil.tin)*100,
         C.N=pct.C.soil/pct.N.soil) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  select(Sample.ID, fraction, pct.N.soil, pct.C.soil, C.N, Sample.mass, soil) %>% 
  rbind(HF_CN) %>% #need to join by sample ID
  rename(fraction.mass=soil) %>% 
  select(Sample.ID, fraction.mass, pct.N.soil, pct.C.soil, fraction) %>% 
  pivot_wider(names_from=fraction, values_from=c(pct.N.soil, pct.C.soil, fraction.mass)) %>% 
  mutate(mg.C.FLF=(pct.C.soil_FLF/100)*fraction.mass_FLF,
         mg.C.OLF=(pct.C.soil_OLF/100)*fraction.mass_OLF,
         mg.C.HF=(pct.C.soil_HF/100)*fraction.mass_HF,
         mg.N.FLF=(pct.N.soil_FLF/100)*fraction.mass_FLF,
         mg.N.OLF=(pct.N.soil_OLF/100)*fraction.mass_OLF,
         mg.N.HF=(pct.N.soil_HF/100)*fraction.mass_HF) %>% 
  mutate(Total.C=mg.C.FLF+ mg.C.OLF+ mg.C.HF,
         Total.N=mg.N.FLF+mg.N.OLF+mg.N.HF) %>% 
  dplyr::select(Sample.ID, Total.C, Total.N)

soil_CN=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, FLF.filter.air.dry.mass..mg., oLF.filter.air.dry.mass..mg., fLF.mass..mg., oLF.mass..mg.) %>% 
  rename(FLF.filter=FLF.filter.air.dry.mass..mg.,OLF.filter=oLF.filter.air.dry.mass..mg., FLF.soil=fLF.mass..mg., 
         OLF.soil=oLF.mass..mg. ) %>% 
  pivot_longer(!Sample.ID, names_to="component", values_to="mass") %>% 
  separate(component, into=c("fraction", "component")) %>% 
  pivot_wider(names_from=component, values_from=mass) %>% 
  mutate(prop.soil=(soil/(soil+filter))) %>% 
  left_join(CN_data, by=c("Sample.ID", "fraction")) %>%
  select(-C.N) %>% 
  mutate(mg.C.tin=((pct.C/100)*Sample.mass),
         mg.N.tin=((pct.N/100)*Sample.mass),
         mg.soil.tin=(prop.soil*Sample.mass)) %>% 
  mutate(pct.C.soil=(mg.C.tin/mg.soil.tin)*100,
         pct.N.soil=(mg.N.tin/mg.soil.tin)*100,
         C.N=pct.C.soil/pct.N.soil) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  select(Sample.ID, fraction, pct.N.soil, pct.C.soil, C.N, Sample.mass, soil) %>% 
  rbind(HF_CN) %>% 
  rename(fraction.mass=soil) %>% 
  left_join(total.fractions.mass, by="Sample.ID") %>% 
  left_join(total.soil.mass, by="Sample.ID") %>%
  left_join(total.C, by="Sample.ID") %>% 
  separate(Sample.ID, into=c("Site", "Plot")) %>% 
  mutate(mg.C=(pct.C.soil/100)*fraction.mass, 
        mg.N=(pct.N.soil/100)*fraction.mass) %>% 
    mutate(mg.C.per.g.soil= mg.C/(mg.total.soil..aim.5000./1000),
         mg.N.per.g.soil= mg.N/(mg.total.soil..aim.5000./1000),
         proportion.C= mg.C/Total.C,
         proportion.N= mg.N/Total.N) %>% 
  left_join(site_clim, by="Site") %>% 
  left_join(CDI, by="Site") %>% 
  unite(col="plotID",c(Site, Plot), sep="_", remove=F) 
#%>% filter(plotID != "DELA_037") 

  
soil_CN$fraction=factor(soil_CN$fraction, levels=c("FLF", "OLF", "HF"))

soil_CN_summary=soil_CN %>% 
   select(Site, field_mean_annual_temperature_C, fraction, proportion.C, proportion.N) %>% 
  group_by(fraction, Site) %>%
    summarize(mean.prop.C=mean(proportion.C),
              mean.prop.N=mean(proportion.N), 
              MAT=mean(field_mean_annual_temperature_C))

#Getting NEON data on trees/site info
# 
#   zipsByProduct(dpID="DP1.10098.001", site=c("BART",  "TREE", "HARV",  "ORNL", "DELA", "LENO", "SERC"), package="basic", savepath="data/")  
#   stackByTable(filepath="data/filesToStack10098/", folder=T)

recent_years=c("vst_BART_2019", "vst_HARV_2019", "vst_TREE_2019",  "vst_ORNL_2017", "vst_DELA_2019", "vst_LENO_2017",  "vst_SERC_2019")


# seed_group=read.delim("WFO_Backbone/classification.txt", header=TRUE) %>%
#   select(genus, majorGroup)
# 
species_names=read.csv("data/filesToStack10098/stackedFiles/vst_mappingandtagging.csv") %>% 
   dplyr::select(individualID, taxonID, scientificName)
# 
# species=species_names %>% 
#   select(scientificName) %>% 
#   distinct() %>%
#   separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
#   left_join(seed_group, by="genus") %>% 
#   distinct() %>% 
#   filter(!is.na(majorGroup),
#          majorGroup!="") %>% 
#   select(genus, majorGroup) %>% 
#   distinct()
# write.csv(species,"genus_group.csv")

majorGroup=read.csv("genus_group.csv") %>% 
  select(-X)
#read in mycorrhizal associations dataset
myc=read.csv("myc_associations.csv") %>% 
  dplyr::rename(taxonID=unique.plot_trees.taxonID.) %>% 
  dplyr::select(taxonID, mycType) 



#Reshape data from woody biomass data product, add mycorrhizal types and calculate % dominance:


plot_trees_a=read.csv("data/filesToStack10098/stackedFiles/vst_apparentindividual.csv") %>% 
  dplyr::filter(eventID %in% recent_years) %>% 
  dplyr::select(siteID, plotID, individualID, plantStatus, stemDiameter) %>% 
  left_join(species_names, by="individualID") %>% 
  filter(grepl("Live", plantStatus)) %>% 
  filter(!is.na(stemDiameter)) %>% 
  mutate(BA=(pi*((stemDiameter/100)/2)^2)) %>% #square meters per plot
  dplyr::group_by(siteID,plotID, taxonID, scientificName) %>% 
  dplyr::summarise(sumBA=sum(BA)) %>% 
  left_join(myc, by="taxonID") %>% 
   na_if("") %>%
  drop_na() %>%
  separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
  left_join(majorGroup, by="genus") %>% 
  dplyr::group_by(plotID) %>% 
  mutate(totalBAbyPlot=sum(sumBA)) %>%
  mutate(speciesDominance=(sumBA/totalBAbyPlot)*100) 

write.csv(plot_trees_a,"plot_tree_species_dominance.csv")

unique_species=plot_trees_a %>%
  unite(spp_name, c(genus, species)) %>% 
  ungroup() %>% 
  filter(speciesDominance > 10) %>% # 70 species with more than 5% BA in any given plot; 61 with more than 10% BA
  distinct(spp_name, .keep_all = TRUE)
write.csv(unique_species, "NEON_spp.csv")

top_three_species_site=plot_trees_a %>% 
  filter(plotID %in% plots) %>% 
  group_by(siteID, taxonID) %>% 
  summarize(sumBA=sum(sumBA)) %>% 
  arrange(siteID,-sumBA) %>% 
  mutate(rank=order(sumBA, decreasing=T)) %>% 
  filter(rank<6)

top_three_species_plot=
plot_trees_a %>% 
  filter(plotID %in% plots) %>% 
  arrange(plotID, speciesDominance) %>% 
  group_by(plotID) %>% 
  mutate(spp_rank=order(speciesDominance, decreasing=T)) %>% 
  filter(spp_rank<4)

plot_trees=plot_trees_a %>% 
  dplyr::group_by(plotID, mycType) %>% 
  mutate(totalBAbyMyc=sum(sumBA)) %>% 
  dplyr::summarise(myc.dominance=(totalBAbyMyc/totalBAbyPlot), plotBA=mean(totalBAbyPlot)) %>%
  separate(plotID, into=c("Site", "Plot"), sep="_", remove=F) %>%
  distinct() %>% 
  pivot_wider(values_from=myc.dominance, names_from=mycType) %>%
  #replace_na(list(E=1, A=0, B=0, ER=0)) %>% I can't remember why I did this
  replace_na(list(E=0, A=0, B=0, ER=0)) %>% 
  filter(plotID %in% plots)

plotPctAngio=read.csv("data/filesToStack10098/stackedFiles/vst_apparentindividual.csv") %>% 
  dplyr::filter(eventID %in% recent_years) %>% 
  dplyr::select(siteID, plotID, individualID, plantStatus, stemDiameter) %>% 
  left_join(species_names, by="individualID") %>% 
  filter(grepl("Live", plantStatus)) %>% 
  filter(!is.na(stemDiameter)) %>% 
  mutate(BA=(pi*((stemDiameter/100)/2)^2)) %>% #square meters per plot
  dplyr::group_by(siteID,plotID, taxonID, scientificName) %>% 
  dplyr::summarise(sumBA=sum(BA)) %>% 
  separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
  left_join(majorGroup, by="genus") %>% 
  na_if("") %>%
  drop_na() %>% 
  dplyr::group_by(plotID) %>% 
  mutate(totalBAbyPlot=sum(sumBA)) %>% 
   dplyr::group_by(plotID, majorGroup) %>% 
  mutate(totalBAbyGroup=sum(sumBA)) %>%
  mutate(pct.group.dominance=(totalBAbyGroup/totalBAbyPlot)) %>% 
  separate(plotID, into=c("Site", "Plot"), sep="_", remove=F) %>%
  distinct() %>% 
  pivot_wider(values_from=pct.group.dominance, names_from=majorGroup) %>%
  select(plotID, A) %>% 
  drop_na() %>% 
  distinct() %>% 
  rename(fractionAngiosperm=A) %>% 
  filter(plotID %in% plots)

angio_dominated=plotPctAngio %>% 
  filter(fractionAngiosperm>0.5)


received_samples=read.csv("Samples_received.csv") %>%
  separate(sampleID, into=c("field_site_id","plot", "horizon", "x", "y","date", "other" )) %>%
  left_join(site_lats, by="field_site_id") %>%
  mutate(plotID= paste(field_site_id, plot, sep="_")) %>%
  left_join(plot_trees, by="plotID") %>%
  filter(horizon=="M") %>%
   dplyr::group_by(Site) %>%
   arrange(Site, E) %>%
   dplyr::mutate(order=row_number()) %>% 
  select(-date, -x, -y, -other)

# #bulk density
bulkdensity=read.csv("data/filesToStack10047/stackedFiles/spc_bulkdensity.csv") %>% 
filter(plotID %in% plots) %>% 
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         bulkDensBottomDepth < 31) 

bulkdensityall=read.csv("data/filesToStack10047/stackedFiles/spc_bulkdensity.csv") %>%
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         bulkDensBottomDepth < 31) %>%
  group_by(siteID) %>%
  summarise(mean_bd=mean(bulkDensOvenDry[!is.na(bulkDensOvenDry)]),
            se_bd=sd(bulkDensOvenDry, na.rm=TRUE) /
              sqrt(length(bulkDensOvenDry[!is.na(bulkDensOvenDry)])),
            mean_bdfm=mean(bulkDensFieldMoist[!is.na(bulkDensFieldMoist)]),
            se_bdfm=sd(bulkDensFieldMoist, na.rm=TRUE) /
              sqrt(length(bulkDensFieldMoist[!is.na(bulkDensFieldMoist)])))
  
  
#soil chemistry, distributed initial characterization

 # zipsByProduct(dpID="DP1.10047.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
 #  stackByTable(filepath="data/filesToStack10047/", folder=T)

soil_biogeochem=read.csv("data/filesToStack10047/stackedFiles/spc_biogeochem.csv") %>% 
    filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         biogeoBottomDepth < 31) %>% 
  select(siteID, plotID, collectDate, horizonName,biogeoSampleType, biogeoTopDepth, biogeoBottomDepth, biogeoCenterDepth, caNh4d, mgNh4d, naNh4d, cecdNh4, alSatCecd33, baseSumCecd10, alKcl, feKcl, mnKcl, phCacl2, phH2o, carbonTot, nitrogenTot, ctonRatio, estimatedOC, sulfurTot, alOxalate, feOxalate, mnOxalate, pOxalate, siOxalate, feCitDithionate, waterRetention15Bar) %>% 
  group_by(plotID) %>% 
  summarise(meansoilFeOx=mean(feOxalate),
            ) %>% 
  arrange(plotID) %>% 
  filter(plotID %in% plots) %>% 
   separate(plotID, into=c("site", "plot"), sep="_", remove=F) 




#particle size
particle_size=read.csv("data/filesToStack10047/stackedFiles/spc_particlesize.csv") %>% 
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         biogeoBottomDepth < 31) %>% 
   group_by(plotID) %>% 
  summarise(meanclay=mean(clayTotal)) %>% 
  separate(plotID, into=c("site", "plot"), sep="_", remove=F) 

clay_summary=particle_size %>% 
  group_by(site) %>% 
 mutate(sitemeanclay=mean(meanclay[!is.na(meanclay)]), sitesdclay=sd(meanclay[!is.na(meanclay)])) %>% 
  select(site, sitemeanclay, sitesdclay) %>% 
  distinct() %>% 
  left_join(site_clim, by=c("site"="Site")) %>% 
    left_join(CDI, by=c("site"="Site"))
write.csv(clay_summary, "clay_site_summary.csv")

#Importing NEON data for soil periodic chemistry measurements:
  # zipsByProduct(dpID="DP1.10086.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
  #    stackByTable(filepath="data/filesToStack10086/", folder=T)

periodic_soil_chem=read.csv("data/filesToStack10086/stackedFiles/sls_soilChemistry.csv")  %>% 
  filter(plotID %in% plots, 
         grepl("-M-",sampleID)) %>% 
  group_by(plotID) %>% 
  summarise(meanNitrogenPercent=mean(nitrogenPercent),
            meanOrganicCarbonPercent=mean(organicCPercent),
            meanCNratio=mean(CNratio),
            meanorganicd13C=mean(organicd13C),
            meand15N=mean(d15N))



full_data_with_fractions=soil_CN %>% 
   pivot_wider(!c(field_mean_annual_precipitation_mm, field_mean_annual_temperature_C), values_from=c(pct.N.soil, pct.C.soil, C.N, Sample.mass, fraction.mass, Total.fractions.mass, Total.C, mg.C, mg.N, mg.C.per.g.soil, mg.N.per.g.soil, proportion.C, proportion.N),names_from=fraction) %>% 
  left_join(plot_trees, by="plotID") %>% 
  left_join(periodic_soil_chem, by="plotID") %>% 
  left_join(site_clim, by=c("Site.x"="Site")) %>%
  left_join(CDI, by=c("Site.x"="Site")) %>%
  arrange(plotID)

neon_full_data= periodic_soil_chem %>%  #periodic characterization
  left_join(soil_biogeochem, by="plotID") %>% #initial characterization
  left_join(plot_trees, by="plotID")

  
 soilCN_trees=soil_CN %>% 
   left_join(plot_trees, by="plotID")
 
 measured_Fe_Ox=read.csv("NEON_FeOx.csv") %>% 
   rename(FeOx=Fe.mg.g) %>% 
   mutate(plotID=str_sub(Sample.ID, 6, -2)) %>% 
   mutate(plotID=sub("-", "_", plotID)) %>% 
   select(-Sample.ID)

final_data=soil_CN %>% 
   pivot_wider(values_from=c(pct.N.soil, pct.C.soil, C.N, Sample.mass, fraction.mass, Total.fractions.mass, Total.C, mg.C, mg.N, mg.C.per.g.soil, mg.N.per.g.soil, proportion.C, proportion.N),names_from=fraction) %>%
left_join(radiocarbon, by="plotID") %>% 
  left_join(plotPctAngio, by="plotID") %>% 
  left_join(plot_trees%>% dplyr::select(-Site, -Plot), by="plotID") %>% 
  arrange(plotID) %>% 
# filter(proportion.C_HF > 0.5) %>% #removed an outlier with crazy big POM fraction
  rename(Site=Site.x) %>% 
  left_join(measured_Fe_Ox, by="plotID") %>% 
left_join( periodic_soil_chem, by="plotID") 

write.csv(final_data, "som_fractions_by_plot.csv")


final_data_tree_spp=final_data %>% 
    arrange(Site, mg.N.per.g.soil_HF) %>%
  group_by(Site) %>% 
  mutate(rank_mgN=order(mg.N.per.g.soil_HF)) %>%
  select(Site, plotID, E, mg.N.per.g.soil_HF, mg.C.per.g.soil_HF, proportion.C_HF, proportion.N_HF, rank_mgN) %>% 
  left_join(top_three_species_plot, by="plotID")


#Soil color palette
soil_fractions=c("#5C4E19", "#9F8A3B", "#DDD1A3")

final_data$Site <- factor(final_data$Site, levels=c('TREE', 'BART', 'HARV','SERC', 'ORNL', 'DELA', 'LENO'))

```

```{r outliers}
#Assessing potential influence of unusual values in final data set

hist(final_data$mg.C.per.g.soil_FLF) #very high concentration of FLF C in one sample
hist(final_data$mg.C.per.g.soil_OLF)
hist(final_data$mg.C.per.g.soil_HF)

hist(final_data$mg.N.per.g.soil_FLF) #very high concentration of FLF N in one sample
hist(final_data$mg.N.per.g.soil_OLF)
hist(final_data$mg.N.per.g.soil_HF)


hist(final_data$proportion.C_FLF) 
hist(final_data$proportion.C_OLF)
hist(final_data$proportion.C_HF)

hist(final_data$proportion.N_FLF) 
hist(final_data$proportion.N_OLF)
hist(final_data$proportion.N_HF)

#removing HARV_037 from final dataset


mean_FLF_conc.C=mean(final_data$mg.C.per.g.soil_FLF) #2.09
std_dev_FLF_conc.C=sd(final_data$mg.C.per.g.soil_FLF) #1.98
#HARV_037 is 47.33, greater than 20 standard deviations above mean

mean_FLF_conc.N=mean(final_data$mg.N.per.g.soil_FLF) #0.106
std_dev_FLF_conc.N=sd(final_data$mg.N.per.g.soil_FLF) #0.205
#HARV_037 has 1.42 mg FLF N per g soil, greater than 6 standard deviations above mean

final_data=final_data %>% 
  filter(plotID != "HARV_037") 

```

```{r map, echo=F, message=F, warning=F, fig.width=11}

site_locations=read.csv("~/Documents/Projects/inProgress/MAOM_Postdoc/NEON_soil_data/20200826_soilSampleData.csv") %>% 
  filter(Site %in% forests) %>% 
  dplyr::group_by(Site) %>%
  dplyr::summarize(lat=mean(decimalLatitude),
            long=mean(decimalLongitude)) %>% 
  filter()

states = map_data("state")
easternUS <- subset(states, region %in% c("maine", "new hampshire", "vermont", "massachusetts", "delaware", "connecticut", "rhode island", "new york", "new jersey", "pennsylvania", "maryland", "virginia", "west virginia", "ohio", "kentucky", "tennessee", "north carolina", "south carolina", "georgia", "florida", "alabama", "mississippi", "indiana", "illinois", "michigan", "wisconsin"))


map=ggplot(data=easternUS)+
  geom_polygon(aes(x=long, y=lat, group=group), fill="white", color="black")+
  coord_fixed(1.3)+
  theme_cowplot()+
  theme(axis.text=element_blank(), axis.line = element_blank(), axis.ticks=element_blank(), axis.title=element_blank(), panel.border = element_rect(linetype="solid", fill=NA))+
  geom_point(aes(x = long, y = lat), data = site_locations, size = 2, color="darkgreen")+
  geom_label_repel(data = site_locations, aes(long, lat, label = Site), size = 3, color="blue",nudge_x = -1, nudge_y = 0.85)

received_samples_plot=received_samples %>% 
  select(-B, -ER) %>% 
  pivot_longer(c(A,E),names_to="myc.type", values_to="dominance") %>% 
  mutate(myc.type=case_when(myc.type=="A" ~ "AM",
                   myc.type=="E" ~ "ECM"))

gradients=ggplot(received_samples_plot, aes(x=order, y=dominance, fill=myc.type))+
  geom_bar(posiiton="stack", stat="identity", colour="black")+
  scale_fill_manual( values=c("gray90", "gray20"))+
  xlab("Study Plot")+
  ylab("Proportion of Basal Area")+
  facet_wrap(~Site, scales="free_x")+
  theme_cowplot()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),strip.background = element_rect( fill="white"),legend.title=element_blank())

ggarrange(map, gradients, nrow=1, ncol=2, legend = "right", labels= c("a","b"))


ggsave("Fig1.pdf", path="figures/", width= 24, height= 12, units="cm")

```

# Site Characteristics

| Site |  MAT (C) | MAP(mm)| Dominant tree species | Soil % clay (Mean +/- SD)| Soil Fe (ox-extractable) |
| ---- |:--------:|:------:|:---------------------:|:-----------:|:--------------:|
| LENO |   18.1   |  1386  | American Sweetgum, American Hornbeam, Possumhaw | 44.7 +- 13.8  | 1.0 +- 0.4 |
| DELA |   17.6   |  1372  | Water oak, Red maple, Sugarberry  | 37.0 +- 6.3  | 0.88 +- 0.2  |
| ORNL |   14.4   |  1340  | Red maple, Sour gum, Chestnut oak |22.0 +- 12.7 | 0.13 +- 0.05 |
| SERC |   13.6   |  1075  | Tulip poplar, American Beech, American Sweetgum |  17.4 +- 6.2 | 0.27 +- 0.1 |
| HARV |   7.4    |  1199  | Eastern Hemlock, Northern Red Oak, American Beech  |  5.5 +- 1.9 | 0.38 +- 0.1
| BART |   6.2    |  1325  | American Beech, Eastern Hemlock, Red maple |  3.6 +- 0.7 | 0.76 +- 0.5 |
| TREE |   4.8    |   797  | Sugar maple, Red maple, Gray alder | 5.4 +- 1.1 |  0.34 +- 0.09  |


<!-- ![fractionated soil sample1](images/IMG_7570.jpg){width=30%}![fractionated soil sample1,  out.extra='angle=90deg' ](images/IMG_0246.jpg){width=30%}![fractionated soil sample1](images/IMG_7568.jpg){width=30%} -->


```{r HF_models, echo=F, message=F, warning=F,fig.width=11, fig.height=9}


c.mod1=lmer(proportion.C_HF ~ E+CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)


c.mod2=lmer(mg.C.per.g.soil_HF ~  E+CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)


n.mod1=lmer(proportion.N_HF ~  E*CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)


n.mod2=lmer(mg.N.per.g.soil_HF ~  E+CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)

#Now doing multiple regression models--does not change results!
# c.mod1=lm(proportion.C_HF ~ E*CDI+FeOx,
#            data=final_data,na.action = na.omit)
# 
# 
# c.mod2=lm(mg.C.per.g.soil_HF ~  E+CDI+FeOx,
#            data=final_data,na.action = na.omit)
# 
# 
# n.mod1=lm(proportion.N_HF ~  E*CDI+FeOx,
#            data=final_data,na.action = na.omit)
# 
# 
# n.mod2=lm(mg.N.per.g.soil_HF ~  E*CDI+FeOx,
#            data=final_data,na.action = na.omit)

#Tab model aesthetics
pl <- c(
  `(Intercept)` = "Intercept",
  E = "Mycorrhizal dominance",
  CDI = "CDI", 
  FeOx = "FeOx",
  `E:CDI`= "Mycorrhizal dominance * CDI"
)

tab_model(c.mod1, c.mod2, n.mod1, n.mod2, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2,pred.labels = pl, 
  dv.labels = c("proportion MAOM C", "[MAOM C]", "proportion MAOM N", "[MAOM N]"), show.df=TRUE, show.std=T)

```

```{r OLF_models, echo=F, message=F, warning=F, fig.width=11, fig.height=9}



c.mod3=lmer(proportion.C_OLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

c.mod4=lmer(mg.C.per.g.soil_OLF ~  E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod3=lmer(proportion.N_OLF ~  E*CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod4=lmer(mg.N.per.g.soil_OLF ~  E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

#Tab model aesthetics
pl <- c(
  `(Intercept)` = "Intercept",
  E = "Mycorrhizal dominance",
  CDI = "CDI", 
  FeOx = "FeOx",
  `E:CDI`= "Mycorrhizal dominance * CDI"
)

tab_model(c.mod3, c.mod4,n.mod3, n.mod4,  show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2,pred.labels = pl, 
  dv.labels = c("proportion oPOM C", "[oPOM C]", "proportion oPOM N", "[oPOM N]"), show.df=TRUE, show.std=T)
# tab_model( n.mod3, n.mod4, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)
```


```{r FLF_models, echo=F, message=F, warning=F, fig.width=11, fig.height=9}



c.mod5=lmer(proportion.C_FLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

c.mod6=lmer(mg.C.per.g.soil_FLF ~  E+CDI+FeOx+(1|Site),
           data=final_data,na.action = na.omit)

n.mod5=lmer(proportion.N_FLF ~  E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod6=lmer(mg.N.per.g.soil_FLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.mod5, c.mod6,n.mod5, n.mod6, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3,show.df=TRUE)

```

```{r MAOM_C_N_calculations}
#what % of total C and N was MAOM C in each site?
pct.MAOM.C=final_data %>% 
  group_by(Site) %>% 
  mutate(mean.C.pro.maom=mean(proportion.C_HF),
         se.pro.maom=sd(proportion.C_HF)/sqrt(46)) %>% 
  dplyr::select(plotID,mean.C.pro.maom, se.pro.maom)

pct.MAOM.N=final_data %>% 
    group_by(Site) %>% 
  mutate(mean.N.pro.maom=mean(proportion.N_HF),
         se.pro.maom.N=sd(proportion.N_HF)/sqrt(46)) %>% 
   dplyr::select(plotID,mean.N.pro.maom, se.pro.maom.N)

# what % of total C and N was MAOM at the lowest %ECM and at the highest %ECM in each site?

end_members_maom_prop=final_data %>% 
  select(Site,Plot.x,E, proportion.C_HF, proportion.N_HF) %>%
  arrange(Site,E) %>% 
   group_by(Site) %>% 
  mutate(myc_rank=order(E, decreasing=T)) %>% 
  mutate(max_A=max(myc_rank)) %>% 
  filter(myc_rank==max_A) %>% 
  ungroup() %>% 
  mutate(mean_prop_C=mean(proportion.C_HF),
         mean_prop_N=mean(proportion.N_HF))

 #At max ECM dominance, avg. proportion C in MAOM was 0.75831, N was 0.85565

#At max AM dominance, avg proportion C in MAOM was 0.83787, N was 0.89959

#from AM to ECM, MAOM C prop dropped 7.956%, N dropped 4.39%

          
```

```{r SOM_proportions_figure, fig.width=14, fig.height=5, include=F}


propC.myc=ggplot(final_data, aes(x=E*100, y=proportion.C_HF, color=Site))+
geom_point(aes(color=Site))+
    scale_colour_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
   geom_point()+
  labs(x=" % ECM basal area ", y=expression("proportion C"[MAOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc=ggplot(final_data, aes(x=E* 100, y=mg.C.per.g.soil_HF, color=Site))+
  geom_point(aes(color=Site))+
     scale_colour_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F, linetype="dashed")+
scale_color_viridis_d()+
  labs(x=" % ECM basal area ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc=ggplot(final_data, aes(x=E*100, y=proportion.N_HF, color=Site))+
  geom_point(aes(color=Site))+
     scale_colour_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F)+
scale_color_viridis_d()+
  labs(x=" % ECM basal area ", y=expression("proportion N"[MAOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

concN.myc=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_HF,color=Site))+
  geom_point(aes(color=Site))+
scale_color_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y="[MAOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc, propN.myc, concC.myc, concN.myc, nrow=2, ncol=2, common.legend=T, legend = "right", labels=c("a", "b", "c", "d"))

ggsave("HF_C_N_by_myc2.pdf", path="figures/", width= 20, height= 18, units="cm")

propC.myc.olf=ggplot(final_data, aes(x=E*100, y=proportion.C_OLF))+
    geom_point(aes(color=Site))+
    scale_colour_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
  labs(x=" % ECM basal area ", y=expression("proportion C"[oPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc.olf=ggplot(final_data, aes(x=E*100, y=mg.C.per.g.soil_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y="[oPOM C] (mg/g soil)", colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc.olf=ggplot(final_data, aes(x=E*100, y=proportion.N_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y=expression("proportion N"[oPOM]), colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concN.myc.olf=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y="[oPOM N] (mg/g soil)", colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc.olf, propN.myc.olf, concC.myc.olf, concN.myc.olf, nrow=2, ncol=2, common.legend=T,legend = "right",labels=c("a", "b", "c", "d"))

propC.myc.flf=ggplot(final_data, aes(x=E*100, y=proportion.C_FLF, color=Site))+
  geom_point(aes(color=Site))+
    scale_colour_viridis_d(option="C")+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
  labs(x=" % ECM basal area ", y=expression("proportion C"[fPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc.flf=ggplot(final_data, aes(x=E*100, y=mg.C.per.g.soil_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y="[fPOM C] (mg/g soil)", colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc.flf=ggplot(final_data, aes(x=E*100, y=proportion.N_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y=expression("proportion N"[fPOM]), colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))



concN.myc.flf=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  labs(x=" % ECM basal area ", y="[fPOM N] (mg/g soil)", colour="Site")+
     scale_colour_viridis_d(option="C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc.flf, propN.myc.flf, concC.myc.flf, concN.myc.flf, nrow=2, ncol=2, common.legend=T,legend = "right", labels=c("a", "b", "c", "d"))



ggarrange(propC.myc.flf, propC.myc.olf, propC.myc, nrow=1, ncol=3, common.legend=T, legend="right", labels=c("a", "b","c"))
ggsave("som.C.proportion.plots2.pdf",path="figures/", width= 30, height= 10, units="cm")

ggarrange(propN.myc.flf, propN.myc.olf, propN.myc, nrow=1, ncol=3, common.legend=T, legend="right", labels=c("a", "b","c"))
ggsave("som.N.proportion.plots2.pdf",path="figures/", width= 30, height= 10, units="cm")

```

```{r CDI_figure, echo=F}

myc_gradient_prophf_slopes=coef(lmList(proportion.C_HF~E|Site , data = final_data))[2]
c.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_prophf_slopes$E) %>% 
  rename("E"="myc_gradient_prophf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_conchf_slopes=coef(lmList(mg.C.per.g.soil_HF~E|Site , data = final_data))[2]
c.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_conchf_slopes$E) %>% 
  rename("E"="myc_gradient_conchf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_propNhf_slopes=coef(lmList(proportion.N_HF~E|Site , data = final_data))[2]
n.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_propNhf_slopes$E) %>% 
  rename("E"="myc_gradient_propNhf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_concNhf_slopes=coef(lmList(mg.N.per.g.soil_HF~E|Site , data = final_data))[2]
n.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_concNhf_slopes$E) %>% 
  rename("E"="myc_gradient_concNhf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

c.mod1.slopes$forests <- factor(c.mod1.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

c.mod2.slopes$forests <- factor(c.mod2.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

n.mod1.slopes$forests <- factor(n.mod1.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

n.mod2.slopes$forests <- factor(n.mod2.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

w=ggplot(aes(x=CDI, y=E, label=forests),data=c.mod1.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
#  geom_text(size=3,hjust=0, nudge_y= -0.015,nudge_x = 0.0015,check_overlap = T)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y=expression(atop("Change in proportion C"[MAOM],paste("with increasing proportion of ECM trees"))))+
  theme_cowplot()+
  ylim(-0.33, 0.33)+
  xlim(0.017, 0.057)+
   theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12), axis.title=element_text(size=13))

x=ggplot(aes(x=CDI, y=E, label=forests),data=c.mod2.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
#  geom_text(size=3,hjust = 0, nudge_y= 0.45, nudge_x = 0.0015)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y="Change in [MAOM C]\n with increasing proportion of ECM trees")+
  theme_cowplot()+
  ylim(-17, 17)+
  xlim(0.017, 0.057)+
  theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12), axis.title=element_text(size=13))

y=ggplot(aes(x=CDI, y=E, label=forests),data=n.mod1.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
  #geom_text(size=3,hjust = 0,nudge_y= -0.015, nudge_x = 0.0015)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y=expression(atop("Change in proportion N"[MAOM],paste("with increasing proportion of ECM trees"))))+
  theme_cowplot()+
  ylim(-0.3, 0.3)+
  xlim(0.017, 0.057)+
 theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12),  axis.title=element_text(size=13))

z=ggplot(aes(x=CDI, y=E, label=forests),data=n.mod2.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y="Change in [MAOM N]\n with increasing proportion of ECM trees")+
  theme_cowplot()+
  ylim(-1.6, 1.6)+
  xlim(0.017, 0.057)+
  theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12),  axis.title=element_text(size=13))

ggarrange(w,x,y,z, labels=c("a", "b", "c", "d"), nrow=2, ncol=2, legend=F)
ggsave("Fig2.pdf", path="figures/", width= 18, height= 16, units="cm")

```





```{r Fe_Ox_figure,fig.width=9, fig.height=7}

concC.fe.hf=ggplot(final_data, aes(x=FeOx, y=mg.C.per.g.soil_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  geom_point()+
   scale_colour_viridis_d(option="C")+
  labs(x=" FeOx (mg/g soil)", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propC.fe.hf=ggplot(final_data, aes(x=FeOx, y=proportion.C_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  geom_point()+
   scale_colour_viridis_d(option="C")+
  labs(x=" FeOx (mg/g soil)", y=expression("proportion C"[MAOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concN.fe.hf=ggplot(final_data, aes(x=FeOx, y=mg.N.per.g.soil_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  geom_point()+
   scale_colour_viridis_d(option="C")+
  labs(x=" FeOx (mg/g soil)", y="[MAOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(concC.fe.hf,concN.fe.hf, nrow=1, ncol=2, common.legend=T, legend="right")
ggsave("hf.conc.CN.fe.pdf",path="figures/", width= 20, height= 10, units="cm")

#what are the slopes of these lines?
fe_conchf_slopes_C=coef(lmList(mg.C.per.g.soil_HF~FeOx|Site , data = final_data))[2]
fe.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(fe_conchf_slopes_C$FeOx) %>% 
  summarize(mean_slope=mean(fe_conchf_slopes_C$FeOx))

fe_conchf_slopes_N=coef(lmList(mg.N.per.g.soil_HF~FeOx|Site , data = final_data))[2]
fe.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(fe_conchf_slopes_N$FeOx) %>% 
  summarize(mean_slope=mean(fe_conchf_slopes_N$FeOx))

```



```{r C_isotopes_models, echo=F, message=F, warning=F}

#can use full dataset for these (no outliers removed)
model.13C=lmer(d13C~FeOx+CDI*E + (1| Site), #
             data=final_data,
             na.action = na.omit)

model.14C=lmer(d14C~FeOx+E+CDI + (1| Site), #
             data=final_data,
             na.action = na.omit)

#how much does d13C change with CDI in this dataset
model.13C.cdi=lm(d13C~CDI, data=final_data)
f3=data.frame(CDI=c(0.0206,0.0494))
predict(model.13C.cdi, newdata=f3)
#from -26.409 at the lowest CDI to -26.453 zat the highest CDI.

tab_model(model.13C, model.14C, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)


model.14C2=lm(d14C~mg.C.per.g.soil_HF,
             data=final_data,
             na.action = na.omit)

model.14C3=lm(d14C~proportion.C_HF,
             data=final_data,
             na.action = na.omit)

model.13C2=lm(d13C~mg.C.per.g.soil_HF,
             data=final_data,
             na.action = na.omit)

model.13C3=lm(d13C~proportion.C_HF,
             data=final_data,
             na.action = na.omit)

tab_model(model.14C2, model.14C3, model.13C2, model.13C3, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)

model.14CDELA=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="DELA",],
             na.action = na.omit)

model.14CLENO=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="LENO",],
             na.action = na.omit)

model.14CSERC=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="SERC",],
             na.action = na.omit)

model.14CHARV=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="HARV",],
             na.action = na.omit)

model.14CBART=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="BART",],
             na.action = na.omit)

model.14CTREE=lm(d14C~FeOx+E+CDI,
             data=final_data[final_data$Site =="TREE",],
             na.action = na.omit)


tab_model(model.14CDELA, model.14CLENO, model.14CSERC, model.14CHARV, model.14CBART, model.14CTREE, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)

model.13CDELA=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="DELA",],
             na.action = na.omit)

model.13CLENO=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="LENO",],
             na.action = na.omit)

model.13CSERC=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="SERC",],
             na.action = na.omit)

model.13CHARV=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="HARV",],
             na.action = na.omit)

model.13CBART=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="BART",],
             na.action = na.omit)

model.13CTREE=lm(d13C~FeOx+E,
             data=final_data[final_data$Site =="TREE",],
             na.action = na.omit)


tab_model(model.13CDELA, model.13CLENO, model.13CSERC, model.13CHARV, model.13CBART, model.13CTREE, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)
```

```{r Radiocarbon_figures, echo=F, warning=F, message=F, fig.width=8}
ggplot(final_data[final_data$Site!= "ORNL",], aes(x=Site, y=d14C))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_hline(yintercept=0, linetype="dashed")+
  labs(y=expression(MAOM~Delta^14*C))+
  scale_x_discrete(limits=c("TREE", "BART", "HARV", "SERC", "DELA", "LENO"))+
  geom_point()+
  theme_cowplot()

ggsave("radiocarbon.by.site.pdf",path="figures/", width= 14, height= 10, units="cm")

radiocarbon.by.CDI=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=CDI, y=d14C))+
  geom_point()+
#  geom_smooth(method="lm", se=T, linetype="dashed", alpha=0.2)+
  scale_color_viridis_d(option="c")+
  labs(x="CDI", y=expression(MAOM~Delta^14*C))+
  theme_cowplot()

radiocarbon.by.ECM=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=E*100, y=d14C))+
  geom_point()+
#  geom_smooth(method="lm", se=T, linetype="dashed", alpha=0.2)+
  labs(x="ECM tree dominance\n(% basal area)", y=expression(MAOM~Delta^14*C))+
  theme_cowplot()

radiocarbon.by.FeOx=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=FeOx, y=d14C))+
  geom_point()+
#  geom_smooth(method="lm", se=T, linetype="dashed", alpha=0.2)+
  labs(x="Oxalate Extractable\nIron Content (%)", y=expression(MAOM~Delta^14*C))+
  theme_cowplot()



d13C.by.CDI=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=CDI, y=d13C))+
  geom_point()+
  geom_smooth(method="lm", se=T, alpha=0.2)+
  labs(x="CDI", y=expression(MAOM~delta^13*C))+
  theme_cowplot()

d13C.by.ECM=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=E*100, y=d13C))+
  geom_point()+
#  geom_smooth(method="lm", linetype="dashed", se=T, alpha=0.2)+
  labs(x="ECM tree dominance\n(% basal area)", y=expression(MAOM~delta^13*C))+
  theme_cowplot()

d13C.by.FeOx=ggplot(final_data[final_data$Site!= "ORNL",], aes(x=FeOx, y=d13C))+
  geom_point()+
  geom_smooth(method="lm", se=T, alpha=0.2)+
  labs(x="Oxalate Extractable\nIron Content (%)", y=expression(MAOM~delta^13*C))+
  theme_cowplot()

ggarrange(radiocarbon.by.CDI, radiocarbon.by.ECM, radiocarbon.by.FeOx, d13C.by.CDI, d13C.by.ECM, d13C.by.FeOx, ncol=3, nrow=2, labels= c("a","b", "c", "d", "e", "f"))
ggsave("MAOM.C.isotopes.pdf", path="figures/", width= 24, height= 14, units="cm")


```


```{r Angiosperm_effects}

ecm_order=received_samples_plot %>% 
  select(plotID, order) %>% 
  distinct()

pctAngio=ggplot(plotPctAngio %>%
                  rename("Angiosperm"="fractionAngiosperm") %>% 
                  mutate(Gymnosperm=1-Angiosperm,
                         plotID=as.character(plotID))%>% 
                           pivot_longer(c(Angiosperm, Gymnosperm), names_to="gymAng", values_to="dominance") %>% 
                  left_join(ecm_order) , aes(x=order, y=dominance, fill=gymAng))+
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual( values=c("gray90", "gray20"))+
  xlab("Study Plot")+
  ylab("Proportion of Basal Area")+
  facet_wrap(~Site, scales="free_x")+
  theme_cowplot()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),strip.background = element_rect( fill="white"),legend.title=element_blank())

ggsave("pctAngioGymno.jpg", path="figures/", width= 20, height= 16, units="cm")

BAbyMYC=ggplot(final_data %>% 
                 left_join(ecm_order), aes(x=order, y=plotBA))+
  geom_bar( stat="identity", colour="black")+
  xlab("Study plots in order of increasing ECM dominance")+
  ylab("Basal Area")+
  facet_wrap(~Site, scales="free_x")+
  theme_cowplot()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),strip.background = element_rect( fill="white"),legend.title=element_blank())

ggsave("BAmyc.jpg", path="figures/", width= 20, height= 16, units="cm")


ggplot(final_data, aes(x=fractionAngiosperm, y=proportion.C_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Angiosperm dominance ", y="MAOM C (proportion)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.ang.prop.jpg", path="figures/", width= 19, height= 16, units="cm")

ggplot(final_data, aes(x=fractionAngiosperm, y=mg.C.per.g.soil_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Angiosperm dominance ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.ang.conc.jpg", path="figures/", width= 19, height= 16, units="cm")

```

```{r Basal_Area_effects, fig.width=11, echo=F, message=F, warning=F}

c.conc.basalArea=lmer(mg.C.per.g.soil_HF ~ plotBA  +(1|Site),
           data=final_data,na.action = na.omit)

n.conc.basalArea=lmer(mg.N.per.g.soil_HF ~ plotBA  +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.conc.basalArea, n.conc.basalArea, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)

```

```{r Climate_effects}
#Relationships between site-level climate decomposition index (CDI) and a) soil oxalate-extractable iron content, and b) total tree basal area in our study plots.

basal_area_cdi=ggplot(final_data, aes(x=CDI, y=plotBA))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
                theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab("Total Basal Area"
  )


feox_cdi=ggplot(final_data, aes(x=CDI, y=FeOx))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
    geom_smooth(method="lm")+
                theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab("Soil Oxalate-Extractable Iron"
  )

ggarrange(basal_area_cdi, feox_cdi, ncol=2, nrow=1, labels= c("a","b"), legend=F)
ggsave("FigS2.pdf", path="figures/", width= 24, height= 12, units="cm")

summary(lm(plotBA~CDI,data=final_data )) #
summary(lm(FeOx~CDI,data=final_data )) #yes, more FeOx in warmer sites
summary(lm(mg.C.per.g.soil_HF~FeOx,data=final_data %>% filter(Site=="LENO") )) #yes within this site Fe Ox is a big driver of concentrations
summary(lm(mg.C.per.g.soil_HF~FeOx,data=final_data %>% filter(Site=="DELA") ))  #yes within this site Fe Ox is a big driver of concentrations

summary(lm(FeOx~E,data=final_data )) #no overall trend with FeOx and ECM dominance across sites
summary(lm(FeOx~E,data=final_data %>% filter(Site=="LENO") )) # yes within LENO positive relationship between soil FeOx and ECM dominance
summary(lm(FeOx~E,data=final_data %>% filter(Site=="DELA") )) # not at all within DELA 

#Site means of MAOM C and N concentrations and proportions, ordered by climate decomposition index

MAOM_C_conc_cdi=ggplot(final_data, aes(x=CDI, y=mg.C.per.g.soil_HF))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
  geom_smooth(method="lm")+
                theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab("[MAOM C] (mg/g soil)"
  )

MAOM_C_prop_cdi=ggplot(final_data, aes(x=CDI, y=proportion.C_HF))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
  theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab(expression("proportion C"[MAOM])
  )

MAOM_N_conc_cdi=ggplot(final_data, aes(x=CDI, y=mg.N.per.g.soil_HF))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
  theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab("[MAOM N] (mg/g soil)"
  )

MAOM_N_prop_cdi=ggplot(final_data, aes(x=CDI, y=proportion.N_HF))+
   geom_point()+
  stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.0009, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.0005, position = position_dodge(width = 0.0009))+
  geom_smooth(method="lm")+
                theme_cowplot()+
  xlab("Climate Decomposition Index")+
  ylab(expression("proportion N"[MAOM])
  )

ggarrange(MAOM_C_conc_cdi, MAOM_C_prop_cdi, MAOM_N_conc_cdi, MAOM_N_prop_cdi, ncol=2, nrow=2, labels= c("a","b", "c", "d"), legend=F)
ggsave("FigXXX.jpg", path="figures/", width= 24, height= 22, units="cm")

```

```{r Iron_ECM}

#Is the amount of oxalate-extractable iron in soil related to mycorrhizal type?

ggplot(final_data, aes(x=E, y=FeOx))+
  geom_point(color="blue")+
  geom_smooth(method="lm", color="blue")+
  facet_wrap(~Site)+
  theme_cowplot()

ggsave("ECM_vs_FeOx.jpg", path="figures/", width= 30, height= 24, units="cm")

ggplot(final_data, aes(x=CDI, y=FeOx))+
  geom_point(color="blue")+
  geom_smooth(method="lm", color="blue")+
  theme_cowplot()

ggsave("CDI_vs_FeOx.pdf", path="figures/", width= 30, height= 24, units="cm")

```

```{r Site_level_MAOM_C , echo=F, include=F}

ggplot(final_data, aes(x=Site, y=mg.C.per.g.soil_HF))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_point()+
  theme_cowplot()

ggplot(final_data, aes(x=Site, y=proportion.C_HF))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_point()+
  theme_cowplot()

```

```{r C:N_figure_and_models, warning=F, echo=F, message=F, fig.width=11, fig.height=4}
ctoN.myc.flf=ggplot(final_data, aes(x=E*100, y=C.N_FLF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="fPOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d(option="C")+
#  ylim(8, 55)+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ctoN.myc.olf=ggplot(final_data, aes(x=E*100, y=C.N_OLF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="oPOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d(option="C")+
#  ylim(8, 55)+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ctoN.myc.hf=ggplot(final_data, aes(x=E*100, y=C.N_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="MAOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d(option="C")+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


ggarrange(ctoN.myc.flf, ctoN.myc.olf, ctoN.myc.hf, nrow=1, ncol=3, common.legend=T,legend = "right", labels=c("a", "b", "c"))
ggsave("cn.myc.pdf",path="figures/", width= 30, height= 10, units="cm")

c.n.mod.flf=lmer(C.N_FLF ~ E+CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)

c.n.mod.olf=lmer(C.N_OLF ~  E+CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)

c.n.mod.hf=lmer(C.N_HF ~  E+CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)


tab_model(c.n.mod.flf, c.n.mod.olf, c.n.mod.hf, show.se = TRUE, show.df=T, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)


#No effects of mycorrhizal type on MAOM C:N in any site
c.n.mod.hf.bart=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="BART"),na.action = na.omit)
c.n.mod.hf.harv=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="HARV"),na.action = na.omit)
c.n.mod.hf.tree=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="TREE"),na.action = na.omit)
c.n.mod.hf.serc=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="SERC"),na.action = na.omit)
c.n.mod.hf.ornl=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="ORNL"),na.action = na.omit)
c.n.mod.hf.dela=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="DELA"),na.action = na.omit)
c.n.mod.hf.leno=lm(C.N_HF ~  E,
           data=final_data %>% filter(Site=="LENO"),na.action = na.omit)

tab_model(c.n.mod.hf.bart,c.n.mod.hf.harv,c.n.mod.hf.tree,c.n.mod.hf.serc,c.n.mod.hf.ornl,c.n.mod.hf.dela,c.n.mod.hf.leno, show.ci = FALSE, digits = 2, digits.re = 2)

#MAOM C:N is higher in cooler sites
ctoN.cdi.hf=ggplot(final_data, aes(x=CDI, y=C.N_HF))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Climate Decomposition Index ", y="MAOM C:N")+
  theme_cowplot()+
  scale_color_viridis_d()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.cn.cdi.pdf",path="figures/", width= 14, height= 12, units="cm")

```
`