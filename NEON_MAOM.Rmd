---
title: 'Patterns in mineral-associated organic matter across scales: untangling the
  influence of climate, mineralogy and mycorrhizal fungi on soil carbon stabilization'
output:
  html_document: default
  pdf_document: default
  word_document: default
date: "11/2021"
---

```{r setup, include=FALSE}
library(tidyverse)
library(cowplot)
library(ggmap)
library(maps)
library(mapdata)
library(nlme) #lme
library(neonUtilities)
library(sjPlot)
library(dotwhisker)
library(lme4) #lmer
library(car)
library(ggpubr)
library(ggrepel)
library(ggeffects)
library(WorldFlora)
library(viridis)
data(vascular.families)
 library(MuMIn)

# Colorblind-friendly palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


forests=c("BART","DELA","HARV","ORNL","TREE","LENO", "SERC")

site_clim=read.csv("NEON_Field_Site_Metadata_20201204.csv") %>% 
  select(field_site_id, field_mean_annual_temperature_C, field_mean_annual_precipitation_mm, field_domint_plant_species) %>% 
  rename(Site=field_site_id) %>%
  filter(Site %in% forests)

CDI=read.csv("CDI.csv")



site_lats=read.csv("NEON_Field_Site_Metadata_20201204.csv") %>% 
  select(field_site_id, field_latitude, field_longitude)

received_sampleID=read.csv("Samples_received.csv") %>%
  select(sampleID) %>% 
  mutate(sampleID = substr(sampleID,1,nchar(sampleID)-3))

sampleIDs=received_sampleID$sampleID

#Radiocarbon decay constant
lambda=1/8267

radiocarbon=read.csv("NEON_14C_data.csv") %>% 
  mutate(yr="2021") %>%  #collection date
 separate(Sample, into=c("Site", "Plot", "fraction")) %>% 
  unite(col=plotID, c(Site, Plot), sep="_", remove=F) %>% 
  mutate(decayRate=(fractionModern*lambda)/(1-fractionModern),
         turnoverTime=1/decayRate) #Calculating decomposition rate of the C. For details about the derivation of this formula see Trumbore et al. (2016).

#My fractionation data: This spreadsheet has been manually updated with re-runs from Elizabeth on April 7 2021. Spreadsheet with both original and re-run values saved as "Full_data_ALNeon_MAOM_EA_results.xlsx"
CN_data=read.csv("SOM_Fractions_CN.csv") %>% 
  separate(Sample.ID, into=c("Site", "Plot", "fraction")) %>% 
  mutate(Site = str_replace(Site, "ORLN", "ORNL")) %>% 
  unite(col="Sample.ID",c(Site, Plot), sep="_") %>% 
  filter(Sample.ID != "STANDARD_FILTER") %>% 
  select(-Count)

plots=unique(CN_data$Sample.ID)

HF_mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
   select(Sample.ID, HF.mass..mg.) 

HF_CN=read.csv("SOM_Fractions_CN.csv") %>% 
  separate(Sample.ID, into=c("Site", "Plot", "fraction")) %>% 
  mutate(Site = str_replace(Site, "ORLN", "ORNL")) %>% 
  filter(Site != "STANDARD",
          fraction == "HF") %>% 
   select(-Count) %>% 
  unite(col="Sample.ID",c(Site, Plot), sep="_") %>% 
  rename(pct.C.soil=pct.C, pct.N.soil=pct.N) %>% 
  left_join(HF_mass) %>% 
  rename(soil=HF.mass..mg.)

total.fractions.mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, Total.fractions.mass)

total.soil.mass=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, mg.total.soil..aim.5000.)


  
total.C=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, FLF.filter.air.dry.mass..mg., oLF.filter.air.dry.mass..mg., fLF.mass..mg., oLF.mass..mg.) %>% 
  rename(FLF.filter=FLF.filter.air.dry.mass..mg.,OLF.filter=oLF.filter.air.dry.mass..mg., FLF.soil=fLF.mass..mg., 
         OLF.soil=oLF.mass..mg. ) %>% 
  pivot_longer(!Sample.ID, names_to="component", values_to="mass") %>% 
  separate(component, into=c("fraction", "component")) %>% 
  pivot_wider(names_from=component, values_from=mass) %>% 
  mutate(prop.soil=(soil/(soil+filter))) %>% 
  left_join(CN_data, by=c("Sample.ID", "fraction")) %>%
  select(-C.N) %>% 
  mutate(mg.C.tin=((pct.C/100)*Sample.mass),
         mg.N.tin=((pct.N/100)*Sample.mass),
         mg.soil.tin=(prop.soil*Sample.mass)) %>% 
  mutate(pct.C.soil=(mg.C.tin/mg.soil.tin)*100,
         pct.N.soil=(mg.N.tin/mg.soil.tin)*100,
         C.N=pct.C.soil/pct.N.soil) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  select(Sample.ID, fraction, pct.N.soil, pct.C.soil, C.N, Sample.mass, soil) %>% 
  rbind(HF_CN) %>% 
  rename(fraction.mass=soil) %>% 
  select(Sample.ID, fraction.mass, pct.N.soil, pct.C.soil, fraction) %>% 
  pivot_wider(names_from=fraction, values_from=c(pct.N.soil, pct.C.soil, fraction.mass)) %>% 
  mutate(mg.C.FLF=(pct.C.soil_FLF/100)*fraction.mass_FLF,
         mg.C.OLF=(pct.C.soil_OLF/100)*fraction.mass_OLF,
         mg.C.HF=(pct.C.soil_HF/100)*fraction.mass_HF,
         mg.N.FLF=(pct.N.soil_FLF/100)*fraction.mass_FLF,
         mg.N.OLF=(pct.N.soil_OLF/100)*fraction.mass_OLF,
         mg.N.HF=(pct.N.soil_HF/100)*fraction.mass_HF) %>% 
  mutate(Total.C=mg.C.FLF+ mg.C.OLF+ mg.C.HF,
         Total.N=mg.N.FLF+mg.N.OLF+mg.N.HF) %>% 
  select(Sample.ID, Total.C, Total.N)

soil_CN=read.csv("SOM_Fractions_Lab_Notebook.csv") %>% 
  select(Sample.ID, FLF.filter.air.dry.mass..mg., oLF.filter.air.dry.mass..mg., fLF.mass..mg., oLF.mass..mg.) %>% 
  rename(FLF.filter=FLF.filter.air.dry.mass..mg.,OLF.filter=oLF.filter.air.dry.mass..mg., FLF.soil=fLF.mass..mg., 
         OLF.soil=oLF.mass..mg. ) %>% 
  pivot_longer(!Sample.ID, names_to="component", values_to="mass") %>% 
  separate(component, into=c("fraction", "component")) %>% 
  pivot_wider(names_from=component, values_from=mass) %>% 
  mutate(prop.soil=(soil/(soil+filter))) %>% 
  left_join(CN_data, by=c("Sample.ID", "fraction")) %>%
  select(-C.N) %>% 
  mutate(mg.C.tin=((pct.C/100)*Sample.mass),
         mg.N.tin=((pct.N/100)*Sample.mass),
         mg.soil.tin=(prop.soil*Sample.mass)) %>% 
  mutate(pct.C.soil=(mg.C.tin/mg.soil.tin)*100,
         pct.N.soil=(mg.N.tin/mg.soil.tin)*100,
         C.N=pct.C.soil/pct.N.soil) %>% 
  mutate_if(is.numeric, list(~na_if(., Inf))) %>% 
  select(Sample.ID, fraction, pct.N.soil, pct.C.soil, C.N, Sample.mass, soil) %>% 
  rbind(HF_CN) %>% 
  rename(fraction.mass=soil) %>% 
  left_join(total.fractions.mass, by="Sample.ID") %>% 
  left_join(total.soil.mass, by="Sample.ID") %>%
  #select( -X.1, -X.2, -X.3, -X.4, -X.5, -X.6, -X.7, -X.8, -X.9, -flf.mass.flf.filter.mass, X..recovery) %>% 
  left_join(total.C, by="Sample.ID") %>% 
  separate(Sample.ID, into=c("Site", "Plot")) %>% 
  mutate(mg.C=(pct.C.soil/100)*fraction.mass, 
        mg.N=(pct.N.soil/100)*fraction.mass) %>% 
    mutate(mg.C.per.g.soil= mg.C/(mg.total.soil..aim.5000./1000),
         mg.N.per.g.soil= mg.N/(mg.total.soil..aim.5000./1000),
         proportion.C= mg.C/Total.C,
         proportion.N= mg.N/Total.N) %>% 
  left_join(site_clim, by="Site") %>% 
  left_join(CDI, by="Site") %>% 
  unite(col="plotID",c(Site, Plot), sep="_", remove=F) %>% 
  filter(plotID != "DELA_037") 

  
soil_CN$fraction=factor(soil_CN$fraction, levels=c("FLF", "OLF", "HF"))

soil_CN_summary=soil_CN %>% 
   select(Site, field_mean_annual_temperature_C, fraction, proportion.C, proportion.N) %>% 
  group_by(fraction, Site) %>%
    summarize(mean.prop.C=mean(proportion.C),
              mean.prop.N=mean(proportion.N), 
              MAT=mean(field_mean_annual_temperature_C))

#Getting NEON data on trees/site info
# 
#   zipsByProduct(dpID="DP1.10098.001", site=c("BART",  "TREE", "HARV",  "ORNL", "DELA", "LENO", "SERC"), package="basic", savepath="data/")  
#   stackByTable(filepath="data/filesToStack10098/", folder=T)

recent_years=c("vst_BART_2019", "vst_HARV_2019", "vst_TREE_2019",  "vst_ORNL_2017", "vst_DELA_2019", "vst_LENO_2017",  "vst_SERC_2019")


# seed_group=read.delim("WFO_Backbone/classification.txt", header=TRUE) %>%
#   select(genus, majorGroup)
# 
species_names=read.csv("data/filesToStack10098/stackedFiles/vst_mappingandtagging.csv") %>% 
   dplyr::select(individualID, taxonID, scientificName)
# 
# species=species_names %>% 
#   select(scientificName) %>% 
#   distinct() %>%
#   separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
#   left_join(seed_group, by="genus") %>% 
#   distinct() %>% 
#   filter(!is.na(majorGroup),
#          majorGroup!="") %>% 
#   select(genus, majorGroup) %>% 
#   distinct()
# write.csv(species,"genus_group.csv")

majorGroup=read.csv("genus_group.csv") %>% 
  select(-X)
#read in mycorrhizal associations dataset
myc=read.csv("myc_associations.csv") %>% 
  dplyr::rename(taxonID=unique.plot_trees.taxonID.) %>% 
  dplyr::select(taxonID, mycType) 



#Reshape data from woody biomass data product, add mycorrhizal types and calculate % dominance:


plot_trees_a=read.csv("data/filesToStack10098/stackedFiles/vst_apparentindividual.csv") %>% 
  dplyr::filter(eventID %in% recent_years) %>% 
  dplyr::select(siteID, plotID, individualID, plantStatus, stemDiameter) %>% 
  left_join(species_names, by="individualID") %>% 
  filter(grepl("Live", plantStatus)) %>% 
  filter(!is.na(stemDiameter)) %>% 
  mutate(BA=(pi*((stemDiameter/100)/2)^2)) %>% #square meters per plot
  dplyr::group_by(siteID,plotID, taxonID, scientificName) %>% 
  dplyr::summarise(sumBA=sum(BA)) %>% 
  left_join(myc, by="taxonID") %>% 
   na_if("") %>%
  drop_na() %>%
  separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
  left_join(majorGroup, by="genus") %>% 
  dplyr::group_by(plotID) %>% 
  mutate(totalBAbyPlot=sum(sumBA)) %>%
  mutate(speciesDominance=(sumBA/totalBAbyPlot)*100) 

unique_species=plot_trees_a %>%
  unite(spp_name, c(genus, species)) %>% 
  ungroup() %>% 
  filter(speciesDominance > 10) %>% # 70 species with more than 5% BA in any given plot; 61 with more than 10% BA
  distinct(spp_name, .keep_all = TRUE)
write.csv(unique_species, "NEON_spp.csv")

top_three_species_site=plot_trees_a %>% 
  filter(plotID %in% plots) %>% 
  group_by(siteID, taxonID) %>% 
  summarize(sumBA=sum(sumBA)) %>% 
  arrange(siteID,-sumBA) %>% 
  mutate(rank=order(sumBA, decreasing=T)) %>% 
  filter(rank<4)

plot_trees=plot_trees_a %>% 
  dplyr::group_by(plotID, mycType) %>% 
  mutate(totalBAbyMyc=sum(sumBA)) %>% 
  dplyr::summarise(myc.dominance=(totalBAbyMyc/totalBAbyPlot), plotBA=mean(totalBAbyPlot)) %>%
  separate(plotID, into=c("Site", "Plot"), sep="_", remove=F) %>%
  distinct() %>% 
  pivot_wider(values_from=myc.dominance, names_from=mycType) %>%
  #replace_na(list(E=1, A=0, B=0, ER=0)) %>% I can't remember why I did this
  replace_na(list(E=0, A=0, B=0, ER=0)) %>% 
  filter(plotID %in% plots)

plotPctAngio=read.csv("data/filesToStack10098/stackedFiles/vst_apparentindividual.csv") %>% 
  dplyr::filter(eventID %in% recent_years) %>% 
  dplyr::select(siteID, plotID, individualID, plantStatus, stemDiameter) %>% 
  left_join(species_names, by="individualID") %>% 
  filter(grepl("Live", plantStatus)) %>% 
  filter(!is.na(stemDiameter)) %>% 
  mutate(BA=(pi*((stemDiameter/100)/2)^2)) %>% #square meters per plot
  dplyr::group_by(siteID,plotID, taxonID, scientificName) %>% 
  dplyr::summarise(sumBA=sum(BA)) %>% 
  separate(scientificName, into=c("genus", "species"), sep=" ") %>% 
  left_join(majorGroup, by="genus") %>% 
  na_if("") %>%
  drop_na() %>% 
  dplyr::group_by(plotID) %>% 
  mutate(totalBAbyPlot=sum(sumBA)) %>% 
   dplyr::group_by(plotID, majorGroup) %>% 
  mutate(totalBAbyGroup=sum(sumBA)) %>%
  mutate(pct.group.dominance=(totalBAbyGroup/totalBAbyPlot)) %>% 
  separate(plotID, into=c("Site", "Plot"), sep="_", remove=F) %>%
  distinct() %>% 
  pivot_wider(values_from=pct.group.dominance, names_from=majorGroup) %>%
  select(plotID, A) %>% 
  drop_na() %>% 
  distinct() %>% 
  rename(fractionAngiosperm=A) %>% 
  filter(plotID %in% plots)


received_samples=read.csv("Samples_received.csv") %>%
  separate(sampleID, into=c("field_site_id","plot", "horizon", "x", "y","date", "other" )) %>%
  left_join(site_lats, by="field_site_id") %>%
  mutate(plotID= paste(field_site_id, plot, sep="_")) %>%
  left_join(plot_trees, by="plotID") %>%
  filter(horizon=="M") %>%
   dplyr::group_by(Site) %>%
   arrange(Site, E) %>%
   dplyr::mutate(order=row_number()) %>% 
  select(-date, -x, -y, -other)

# #bulk density
bulkdensity=read.csv("data/filesToStack10047/stackedFiles/spc_bulkdensity.csv") %>% 
filter(plotID %in% plots) %>% 
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         bulkDensBottomDepth < 31) 

bulkdensityall=read.csv("data/filesToStack10047/stackedFiles/spc_bulkdensity.csv") %>%
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         bulkDensBottomDepth < 31) %>%
  group_by(siteID) %>%
  summarise(mean_bd=mean(bulkDensOvenDry[!is.na(bulkDensOvenDry)]),
            se_bd=sd(bulkDensOvenDry, na.rm=TRUE) /
              sqrt(length(bulkDensOvenDry[!is.na(bulkDensOvenDry)])),
            mean_bdfm=mean(bulkDensFieldMoist[!is.na(bulkDensFieldMoist)]),
            se_bdfm=sd(bulkDensFieldMoist, na.rm=TRUE) /
              sqrt(length(bulkDensFieldMoist[!is.na(bulkDensFieldMoist)])))
  
  
#soil chemistry, distributed initial characterization

 # zipsByProduct(dpID="DP1.10047.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
 #  stackByTable(filepath="data/filesToStack10047/", folder=T)

soil_biogeochem=read.csv("data/filesToStack10047/stackedFiles/spc_biogeochem.csv") %>% 
    filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         biogeoBottomDepth < 31) %>% 
  select(siteID, plotID, collectDate, horizonName,biogeoSampleType, biogeoTopDepth, biogeoBottomDepth, biogeoCenterDepth, caNh4d, mgNh4d, naNh4d, cecdNh4, alSatCecd33, baseSumCecd10, alKcl, feKcl, mnKcl, phCacl2, phH2o, carbonTot, nitrogenTot, ctonRatio, estimatedOC, sulfurTot, alOxalate, feOxalate, mnOxalate, pOxalate, siOxalate, feCitDithionate, waterRetention15Bar) %>% 
  group_by(plotID) %>% 
  summarise(meansoilFeOx=mean(feOxalate)) %>% 
  arrange(plotID) %>% 
  filter(plotID %in% plots) %>% 
   separate(plotID, into=c("site", "plot"), sep="_", remove=F) 




#particle size
particle_size=read.csv("data/filesToStack10047/stackedFiles/spc_particlesize.csv") %>% 
  filter(!grepl("E",horizonName),
         !grepl("O",horizonName),
         !grepl("C",horizonName),
         biogeoBottomDepth < 31) %>% 
   group_by(plotID) %>% 
  summarise(meanclay=mean(clayTotal)) %>% 
  separate(plotID, into=c("site", "plot"), sep="_", remove=F) 

clay_summary=particle_size %>% 
  group_by(site) %>% 
 mutate(sitemeanclay=mean(meanclay[!is.na(meanclay)]), sitesdclay=sd(meanclay[!is.na(meanclay)])) %>% 
  select(site, sitemeanclay, sitesdclay) %>% 
  distinct() %>% 
  left_join(site_clim, by=c("site"="Site")) %>% 
    left_join(CDI, by=c("site"="Site"))



# litter_chem_plots=litter_chem %>% 
#   filter(plotID %in% plots)

#Soil periodic measurements:
  # zipsByProduct(dpID="DP1.10086.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
  #    stackByTable(filepath="data/filesToStack10086/", folder=T)

periodic_soil_chem=read.csv("data/filesToStack10086/stackedFiles/sls_soilChemistry.csv")  %>% 
  filter(plotID %in% plots, 
         grepl("-M-",sampleID)) %>% 
  group_by(plotID) %>% 
  summarise(meanNitrogenPercent=mean(nitrogenPercent),
            meanOrganicCarbonPercent=mean(organicCPercent),
            meanCNratio=mean(CNratio),
            meanorganicd13C=mean(organicd13C),
            meand15N=mean(d15N))

sample_depths=read.csv("data/filesToStack10047/stackedFiles/spc_biogeochem.csv") %>%
  filter(plotID %in% plots) %>% 
  filter(siteID=="HARV")

organic_horizon_chem=read.csv("data/filesToStack10086/stackedFiles/sls_soilChemistry.csv")  %>% 
  filter(plotID %in% plots, 
         grepl("-O-",sampleID)) %>% 
  group_by(plotID) %>% 
  summarise(meanNitrogenPercent=mean(nitrogenPercent),
            meanOrganicCarbonPercent=mean(organicCPercent),
            meanCNratio=mean(CNratio)) %>% 
    left_join(plot_trees, by="plotID") 

moisturesubs=read.csv("moisturesubs.csv")
periodic_moisture=read.csv("data/filesToStack10086/stackedFiles/sls_soilMoisture.csv")%>% 
  #filter(grepl("-M-",sampleID)) %>% 
  filter(!is.na(dryMassFraction)) %>%
  group_by(plotID) %>% 
  summarise(meandryMassFraction=mean(dryMassFraction)) %>% 
  filter(plotID %in% plots) %>% 
  rbind(moisturesubs) %>%  #Missing 3 bartlett plots: 032 (substitute 071), 033 (substitute 036), 034 (substitute 036).
  arrange(plotID) %>% 
  mutate(meandryMassFraction=as.numeric(meandryMassFraction))

pHsubs=read.csv("pHsubs.csv")
periodic_pH=read.csv("data/filesToStack10086/stackedFiles/sls_soilpH.csv")%>% 
 # filter(grepl("-M-",sampleID)) %>% 
  filter(!is.na(soilInWaterpH)) %>% 
  group_by(plotID) %>% 
  summarise(meanpH=mean(soilInWaterpH)) %>% 
    filter(plotID %in% plots) %>% 
  rbind(pHsubs) %>%  #Missing 3 bartlett plots: 032 (substitute 071), 033 (substitute 036), 034 (substitute 036).
  arrange(plotID)


#microbial group abundances:
 # zipsByProduct(dpID="DP1.10109.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
 # stackByTable(filepath="data/filesToStack10109/", folder=T)
FBsubs=read.csv("FBsubs.csv")
microbesFB=read.csv("~/Documents/Projects/inProgress/MAOM_Postdoc/NEON_soil_data/data/filesToStack10109/stackedFiles/mga_soilGroupAbundances.csv") %>% 
  #filter(grepl("-M-", geneticSampleID)) %>% 
  group_by(plotID, targetTaxonGroup) %>%
  summarise(meanCopyNumber=mean(meanCopyNumber)) %>% 
  pivot_wider(names_from=targetTaxonGroup, values_from=meanCopyNumber) %>% 
  rename("meanCopyNumBactArch"="bacteria and archaea",
         "meanCopyNumFungi"=fungi) %>% 
  select(-bacteria, -archaea) %>% 
  mutate(FB=meanCopyNumFungi/meanCopyNumBactArch) %>% 
  filter(FB<.02)%>% 
  filter(plotID %in% plots) %>%   #Missing 3 bartlett plots: 032 (substitute 071), 033 (substitute 036), 034 (substitute 036) and 3 Harvard plots: 001 (sub 020), 004 (sub 020), 016 (sub 020)
rbind(FBsubs) %>% 
  arrange(plotID)


microbesFB_plots=microbesFB %>% 
  filter(plotID %in% plots) %>% 
  left_join(plot_trees)

#microbial biomass: Missing all Bartlett data
 # zipsByProduct(dpID="DP1.10104.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
 # stackByTable(filepath="data/filesToStack10104/", folder=T)
 #  

microbialBiomass=read.csv("data/filesToStack10104/stackedFiles/sme_microbialBiomass.csv") %>% 
  filter(grepl("-M-", sampleID)) %>%
  group_by(plotID) %>% 
  summarize(meanTotalLipidConcentration=mean(totalLipidConcentration))

# microbial community composition
# zipsByProduct(dpID="DP1.10081.001", site=c("BART", "HARV", "TREE",  "ORNL", "DELA", "LENO",  "SERC"), package="basic", savepath="data/")
# stackByTable(filepath="data/filesToStack10081/", folder=T)
  
bacterialCommunity=read.csv("data/filesToStack10081/stackedFiles/mcc_soilSeqVariantMetadata_16S.csv") %>% 
  filter(grepl("-M-", geneticSampleID)) %>%
  group_by(plotID) %>% 
  summarize(mean16SSFRN=mean(sampleFilteredReadNumber))
  
fungalCommunity=read.csv("data/filesToStack10081/stackedFiles/mcc_soilSeqVariantMetadata_ITS.csv") %>% 
  filter(grepl("-M-", geneticSampleID)) %>%
  group_by(plotID) %>% 
  summarize(meanITSSFRN=mean(sampleFilteredReadNumber))


full_data_with_fractions=soil_CN %>% 
   pivot_wider(!c(field_mean_annual_precipitation_mm, field_mean_annual_temperature_C), values_from=c(pct.N.soil, pct.C.soil, C.N, Sample.mass, fraction.mass, Total.fractions.mass, Total.C, mg.C, mg.N, mg.C.per.g.soil, mg.N.per.g.soil, proportion.C, proportion.N),names_from=fraction) %>% 
  left_join(plot_trees, by="plotID") %>% 
  left_join(periodic_soil_chem, by="plotID") %>% 
  left_join(periodic_moisture, by="plotID") %>% 
  left_join(periodic_pH, by="plotID") %>% 
 #  left_join(litter_chem, by="plotID") %>% 
  #left_join(soil_biogeochem, by="plotID") %>% 
  #left_join(soil_biogeochem_fe_summary, by=c("Site.x"="Site")) %>% 
  #left_join(particle_size, by="plotID") %>% 
  left_join(clay_summary, by=c("Site.x"="site")) %>% 
  left_join(microbesFB, by="plotID") %>% 
  #left_join(microbialBiomass, by="plotID") %>% 
 # left_join(bacterialCommunity, by="plotID") %>%
  #left_join(fungalCommunity, by="plotID") %>% 
  left_join(site_clim, by=c("Site.x"="Site")) %>%
  left_join(CDI, by=c("Site.x"="Site")) %>%
  arrange(plotID)

neon_full_data= periodic_soil_chem %>%  #periodic characterization
  left_join(periodic_pH, by="plotID") %>% 
  left_join(soil_biogeochem, by="plotID") %>% #initial characterization
#    left_join(litter_chem, by="plotID") %>% #litter
  left_join(plot_trees, by="plotID")

  
 soilCN_trees=soil_CN %>% 
   left_join(plot_trees, by="plotID")
 
 measured_Fe_Ox=read.csv("NEON_FeOx.csv") %>% 
   rename(FeOx=Fe....) %>% 
   mutate(plotID=str_sub(Sample.ID, 6, -2)) %>% 
   mutate(plotID=sub("-", "_", plotID)) %>% 
   select(-Sample.ID)

final_data=soil_CN %>% 
   pivot_wider(values_from=c(pct.N.soil, pct.C.soil, C.N, Sample.mass, fraction.mass, Total.fractions.mass, Total.C, mg.C, mg.N, mg.C.per.g.soil, mg.N.per.g.soil, proportion.C, proportion.N),names_from=fraction) %>%
left_join(radiocarbon, by="plotID") %>% 
  left_join(plotPctAngio, by="plotID") %>% 
  left_join(plot_trees%>% dplyr::select(-Site, -Plot), by="plotID") %>% 
  arrange(plotID) %>% 
 filter(proportion.C_HF > 0.5) %>% #removed an outlier with crazy big POM fraction
  rename(Site=Site.x) %>% 
  left_join(measured_Fe_Ox, by="plotID") %>% 
left_join( periodic_soil_chem, by="plotID") 


#Color palette
soil_fractions=c("#5C4E19", "#9F8A3B", "#DDD1A3")



```
## Question: *What controls patterns in MAOM content in forest soil?*

## Expectations:
### 1. Climate and soil characteristics will explain most of the patterns in MAOM content and stability, and these controls vary by site and over large spatial scales. 
#### - Warmer sites and sites with more clay and iron oxides will have greater concentrations of MAOM. 
#### - MAOM turnover will be more strongly controlled by mineralogy, with more clay-rich and iron-rich sites having the oldest and most stable MAOM.

#### *Counterpoint: Warmer sites should also have smaller standing nutrient pools, which may lead to more root exudation from trees, or mining by associated fungi, as a way to liberate nutrients from MAOM. This may result in smaller, more dynamic MAOM stocks with relatively short turnover times.*

### 2. Within-site patterns in tree mycorrhizal association will explain a smaller but still important amount of variation in MAOM content and turnover time.
#### - ECM-dominated plots will have less MAOM than AM-dominated plots
#### - ECM-dominated plots will have shorter MAOM turnover times than AM-dominated plots (because ECM taxa may be able to liberate mineral-bound SOM)


## Introduction
### Study design: Soils collected in seven forested NEON sites across the Eastern U.S. (Fig 1). At each site, soils were collected within 6-7 plots that spanned a range of AM vs ECM tree dominance:

```{r map, echo=F, message=F, warning=F, fig.width=11}

site_locations=read.csv("~/Documents/Projects/inProgress/MAOM_Postdoc/NEON_soil_data/20200826_soilSampleData.csv") %>% 
  filter(Site %in% forests) %>% 
  dplyr::group_by(Site) %>%
  dplyr::summarize(lat=mean(decimalLatitude),
            long=mean(decimalLongitude)) %>% 
  filter()

states = map_data("state")
easternUS <- subset(states, region %in% c("maine", "new hampshire", "vermont", "massachusetts", "delaware", "connecticut", "rhode island", "new york", "new jersey", "pennsylvania", "maryland", "virginia", "west virginia", "ohio", "kentucky", "tennessee", "north carolina", "south carolina", "georgia", "florida", "alabama", "mississippi", "indiana", "illinois", "michigan", "wisconsin"))


map=ggplot(data=easternUS)+
  geom_polygon(aes(x=long, y=lat, group=group), fill="white", color="black")+
  coord_fixed(1.3)+
  theme_cowplot()+
  theme(axis.text=element_blank(), axis.line = element_blank(), axis.ticks=element_blank(), axis.title=element_blank(), panel.border = element_rect(linetype="solid", fill=NA))+
  geom_point(aes(x = long, y = lat), data = site_locations, size = 2, color="darkgreen")+
  geom_label_repel(data = site_locations, aes(long, lat, label = Site), size = 3, color="blue",nudge_x = -1, nudge_y = 0.85)

received_samples_plot=received_samples %>% 
  select(-B, -ER) %>% 
  pivot_longer(c(A,E),names_to="myc.type", values_to="dominance") %>% 
  mutate(myc.type=case_when(myc.type=="A" ~ "AM",
                   myc.type=="E" ~ "ECM"))

gradients=ggplot(received_samples_plot, aes(x=order, y=dominance, fill=myc.type))+
  geom_bar(posiiton="stack", stat="identity", colour="black")+
  scale_fill_manual( values=c("gray90", "gray20"))+
  xlab("Study Plot")+
  ylab("Proportion of Basal Area")+
  facet_wrap(~Site, scales="free_x")+
  theme_cowplot()+
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),strip.background = element_rect( fill="white"),legend.title=element_blank())

ggarrange(map, gradients, nrow=1, ncol=2, legend = "right", labels= c("a","b"))


ggsave("Fig1.jpg", path="figures/", width= 24, height= 12, units="cm")

```

# Site Characteristics

| Site |  MAT (C) | MAP(mm)| Dominant tree species | Soil % clay (Mean +/- SD)| Soil Fe (ox-extractable) |
| ---- |:--------:|:------:|:---------------------:|:-----------:|:--------------:|
| LENO |   18.1   |  1386  | American Sweetgum, American Hornbeam, Possumhaw | 44.7 +- 13.8  | 1.0 +- 0.4 |
| DELA |   17.6   |  1372  | Water oak, Red maple, Sugarberry  | 37.0 +- 6.3  | 0.88 +- 0.2  |
| ORNL |   14.4   |  1340  | Red maple, Sour gum, Chestnut oak |22.0 +- 12.7 | 0.13 +- 0.05 |
| SERC |   13.6   |  1075  | Tulip poplar, American Beech, American Sweetgum |  17.4 +- 6.2 | 0.27 +- 0.1 |
| HARV |   7.4    |  1199  | Eastern Hemlock, Northern Red Oak, American Beech  |  5.5 +- 1.9 | 0.38 +- 0.1
| BART |   6.2    |  1325  | American Beech, Eastern Hemlock, Red maple |  3.6 +- 0.7 | 0.76 +- 0.5 |
| TREE |   4.8    |   797  | Sugar maple, Red maple, Gray alder | 5.4 +- 1.1 |  0.34 +- 0.09  |


<!-- ![fractionated soil sample1](images/IMG_7570.jpg){width=30%}![fractionated soil sample1,  out.extra='angle=90deg' ](images/IMG_0246.jpg){width=30%}![fractionated soil sample1](images/IMG_7568.jpg){width=30%} -->


```{r CN.fractions, echo=F, message=F, warning=F, eval=F}


ggplot(soil_CN, aes(x=Site, y=C.N, colour=fraction))+
    stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  scale_colour_manual(values=soil_fractions)+
   labs(x="  ", y=" C:N", colour="Soil Fraction")+
   theme_cowplot()+
  theme(legend.position="top",legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text.y=element_text(size=15), axis.title=element_text(size=19), axis.text.x = element_text( angle = 30, hjust=1, vjust=1, size=15))
ggsave("cn.fractions.jpg", path="figures/", width= 21, height= 12, units="cm")

```



```{r propC.fractions, echo=F, message=F, warning=F, eval=F, include=F}


ggplot(soil_CN_summary, aes(x=reorder(Site, -MAT), fill=fraction, y=mean.prop.C)) + 
    geom_bar(position="stack", stat="identity")+
  scale_fill_manual(name= "Soil Fraction", values=soil_fractions)+
  labs(x=" ", y="Mean proportion of total C" )+
  theme_cowplot()+
  theme(axis.text.x = element_text( angle = 30, hjust=1, vjust=1, size=15), axis.title.y=element_text(size=18))
ggsave("propC_site.jpg", path="figures/", width= 21, height= 17, units="cm")



```


```{r climateCproportions, echo=F, message=F, warning=F, eval=F, include=F}
ggplot(soil_CN, aes(x=field_mean_annual_temperature_C, y=proportion.C, colour=fraction))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Mean Annual Temperature ", y="Proportion C ", colour="Soil Fraction")+
  scale_colour_manual(values= soil_fractions)+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.mat.jpg", path="figures/", width= 14, height= 12, units="cm")

ggplot(final_data, aes(x=CDI, y=plotBA))+
#   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)

```



```{r MATTest, echo=F, message=F, warning=F, eval=F, include=F}

prop.clim.mod=lm(proportion.C~field_mean_annual_temperature_C * fraction +field_mean_annual_precipitation_mm*fraction, data=soil_CN, na.action = na.omit)

tab_model(prop.clim.mod, show.se = TRUE, show.ci = FALSE, digits = 3, digits.re = 3)

```


```{r MATClay, echo=F, message=F, warning=F, include=F}

ggplot(clay_summary, aes(x=field_mean_annual_temperature_C, y=sitemeanclay))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Mean Annual Temperature ", y="Percent clay ")+
  geom_text(x=6, y=30, label="R^2 = 0.88")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggplot(clay_summary, aes(x=CDI, y=sitemeanclay))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" CDI ", y="Percent clay ")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

clayC=soil_CN %>% 
  left_join(clay_summary)

ggplot(clayC, aes(x=sitemeanclay, y=proportion.C, colour=fraction))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Mean % Clay ", y="Proportion C ", colour="Soil Fraction")+
   scale_colour_manual(values= soil_fractions)+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

```



```{r Mat_MAOM, echo=F, message=F, warning=F,eval=F, include=F}

ggplot(full_data_with_fractions[which(full_data_with_fractions$proportion.C_HF>0.5),], aes(x=field_mean_annual_temperature_C.x, y=proportion.C_HF))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" MAT ", y="MAOM C (proportion)")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.mat.prop.jpg", path="figures/", width= 19, height= 16, units="cm")

mat.propCMAOM=lm(proportion.C_HF~field_mean_annual_temperature_C.x,data=full_data_with_fractions[which(full_data_with_fractions$proportion.C_HF>0.5),])
summary(mat.propCMAOM)



ggplot(full_data_with_fractions[which(full_data_with_fractions$mg.C.per.g.soil_HF>0.5),], aes(x=field_mean_annual_temperature_C.x, y=mg.C.per.g.soil_HF, colour=Site.x))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" MAT ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.mat.conc.jpg", path="figures/", width= 19, height= 16, units="cm")

```

```{r CDI_MAOM, echo=F, message=F, warning=F,eval=F, include=F}

ggplot(final_data, aes(x=CDI, y=proportion.C_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" CDI ", y="MAOM C (proportion)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.cdi.prop.jpg", path="figures/", width= 19, height= 16, units="cm")

ggplot(clean_data_with_fractions[which(clean_data_with_fractions$mg.C.per.g.soil_HF>0.5),], aes(x=CDI, y=mg.C.per.g.soil_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" CDI ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.cdi.conc.jpg", path="figures/", width= 19, height= 16, units="cm")
```



```{r Ang_MAOM, echo=F, message=F, warning=F, eval=F}

ggplot(final_data, aes(x=fractionAngiosperm, y=proportion.C_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Angiosperm dominance ", y="MAOM C (proportion)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.ang.prop.jpg", path="figures/", width= 19, height= 16, units="cm")

ggplot(final_data, aes(x=fractionAngiosperm, y=mg.C.per.g.soil_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" Angiosperm dominance ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggsave("maom.ang.conc.jpg", path="figures/", width= 19, height= 16, units="cm")
```


```{r test , eval=F, echo=F, include=F}

ggplot(final_data, aes(x=Site, y=mg.C.per.g.soil_HF))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_point()+
  theme_cowplot()

ggplot(final_data, aes(x=Site, y=proportion.C_HF))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_point()+
  theme_cowplot()

```



```{r HF_models, echo=F, message=F, warning=F,fig.width=11, fig.height=9}

#Need to make a color scale going from red to blue for MAT, label legend with Site names
cdi_colors=c("dodgerblue4", "dodgerblue1", "skyblue", "gray77", "rosybrown1", "tomato", "tomato3")

propC.myc=ggplot(final_data, aes(x=E*100, y=proportion.C_HF, color=Site))+
geom_point(aes(color=Site))+
    scale_colour_viridis_d()+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
   geom_point()+
  labs(x=" % ECM basal area ", y=expression("proportion C"[MAOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc=ggplot(final_data, aes(x=E* 100, y=mg.C.per.g.soil_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc=ggplot(final_data, aes(x=E*100, y=proportion.N_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y=expression("proportion N"[MAOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

concN.myc=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_HF,color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[MAOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

#This was with the SEs filled in color same as site
# concN.myc=ggplot(final_data, aes(x=FeOx, y=mg.N.per.g.soil_HF, colour=Site))+
#    geom_smooth(method="lm",size=2, se=T, alpha=0.2, aes(fill=Site))+
#   scale_color_viridis(discrete=T)+
#   scale_fill_viridis(discrete=T)+
#   labs(x=" % FeOx ", y="[MAOM N] (mg/g soil)", colour="Site")+
#   theme_cowplot()+
#   theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc, propN.myc, concC.myc, concN.myc, nrow=2, ncol=2, common.legend=T, legend = "right", labels=c("a", "b", "c", "d"))


#with lme (nlme): can't compute the conditional r2 for c mod 2
#with lmer (lme4): can't compute the condtional r2 for n mod 1

#first with lme:
# c.mod1=lme(proportion.C_HF ~ E+CDI+FeOx, random=(~1|Site),
#            data=final_data,na.action = na.omit)
# r.squaredGLMM(c.mod1)
# r=rsquared(c.mod1)
# 
# c.mod2=lme(mg.C.per.g.soil_HF ~  E+CDI+FeOx, random=(~1|Site),
#            data=final_data,na.action = na.omit)
# r.squaredGLMM(c.mod2) #from MuMIn package. for some reason this is not matching up with the sjplot R2 (all others are)
# r=rsquared(c.mod2) #from piecewiseSEM package
# 
# n.mod1=lme(proportion.N_HF ~  E*CDI+FeOx, random=(~1|Site),
#            data=final_data,na.action = na.omit)
# r.squaredGLMM(n.mod1)
# r=rsquared(n.mod1)
# 
# n.mod2=lme(mg.N.per.g.soil_HF ~  E*CDI+FeOx, random=(~1|Site),
#            data=final_data,na.action = na.omit)
# r.squaredGLMM(n.mod2)
# r=rsquared(n.mod2)

#now with lmer:

c.mod1=lmer(proportion.C_HF ~ E+CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)
#c.mod1=lmer(proportion.C_HF ~ E*field_mean_annual_temperature_C+FeOx+ (1|Site),
          # data=final_data,na.action = na.omit)
# r.squaredGLMM(c.mod1)
# r=rsquared(c.mod1)

c.mod2=lmer(mg.C.per.g.soil_HF ~  E+CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)
#c.mod2=lmer(mg.C.per.g.soil_HF ~  E*field_mean_annual_temperature_C+FeOx+ (1|Site),
          # data=final_data,na.action = na.omit)
# r.squaredGLMM(c.mod2) #from MuMIn package.
# r=rsquared(c.mod2) #from piecewiseSEM package

n.mod1=lmer(proportion.N_HF ~  E*CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)
#n.mod1=lmer(proportion.N_HF ~  E*field_mean_annual_temperature_C+FeOx+ (1|Site),
         #  data=final_data,na.action = na.omit)
# r.squaredGLMM(n.mod1)
# r=rsquared(n.mod1)

n.mod2=lmer(mg.N.per.g.soil_HF ~  E*CDI+FeOx+ (1|Site),
           data=final_data,na.action = na.omit)
#n.mod2=lmer(mg.N.per.g.soil_HF ~  E*field_mean_annual_temperature_C+FeOx+ (1|Site),
#           data=final_data,na.action = na.omit)
# r.squaredGLMM(n.mod2)
# r=rsquared(n.mod2)

pl <- c(
  `(Intercept)` = "Intercept",
  E = "Mycorrhizal dominance",
  CDI = "CDI", 
  FeOx = "FeOx",
  `E:CDI`= "Mycorrhizal dominance * CDI"
)

tab_model(c.mod1, c.mod2, n.mod1, n.mod2, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2,pred.labels = pl, 
  dv.labels = c("proportion MAOM C", "[MAOM C]", "proportion MAOM N", "[MAOM N]"), show.df=TRUE)


#what % of total C was MAOM C in each site?
pct.MAOM.C=final_data %>% 
  mutate(mean.C.pro.maom=mean(proportion.C_HF),
         se.pro.maom=sd(proportion.C_HF)/sqrt(46))

pct.MAOM.N=final_data %>% 
  mutate(mean.N.pro.maom=mean(proportion.N_HF),
         se.pro.maom.N=sd(proportion.N_HF)/sqrt(46))

# what % of total C was MAOM at the lowest %ECM and at the highest %ECM in each site?
#Need to isolate lowest and highest sites along each gradient, then average the prop C and prop N HF
end_members_maom_prop=final_data %>% 
  select(Site,Plot.x,E, proportion.C_HF, proportion.N_HF) %>% 
  group_by(Site) %>% 
  mutate(myc_rank=order(E)) %>% 
  mutate(maxE=max(myc_rank)) %>% 
  filter(myc_rank==maxE)

  

          
```

```{r CDI_figure, echo=F}

myc_gradient_prophf_slopes=coef(lmList(proportion.C_HF~E|Site , data = final_data))[2]
c.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_prophf_slopes$E) %>% 
  rename("E"="myc_gradient_prophf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_conchf_slopes=coef(lmList(mg.C.per.g.soil_HF~E|Site , data = final_data))[2]
c.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_conchf_slopes$E) %>% 
  rename("E"="myc_gradient_conchf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_propNhf_slopes=coef(lmList(proportion.N_HF~E|Site , data = final_data))[2]
n.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_propNhf_slopes$E) %>% 
  rename("E"="myc_gradient_propNhf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

myc_gradient_concNhf_slopes=coef(lmList(mg.N.per.g.soil_HF~E|Site , data = final_data))[2]
n.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(myc_gradient_concNhf_slopes$E) %>% 
  rename("E"="myc_gradient_concNhf_slopes$E") %>% 
  left_join(CDI, by=c("forests"="Site"))

c.mod1.slopes$forests <- factor(c.mod1.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

c.mod2.slopes$forests <- factor(c.mod2.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

n.mod1.slopes$forests <- factor(n.mod1.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

n.mod2.slopes$forests <- factor(n.mod2.slopes$forests, levels=c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))

w=ggplot(aes(x=CDI, y=E, label=forests),data=c.mod1.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
#  geom_text(size=3,hjust=0, nudge_y= -0.015,nudge_x = 0.0015,check_overlap = T)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y=expression(atop("Change in proportion C"[MAOM],paste("along mycorrhizal gradient"))))+
  theme_cowplot()+
  ylim(-0.33, 0.33)+
  xlim(0.017, 0.057)+
   theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12), axis.title=element_text(size=13))

# expression(paste("A long string of text goes here just for the purpose \n of illustrating my point Weight "[reported])))
# labs(y=expression(MAOM~delta^14*C))

x=ggplot(aes(x=CDI, y=E, label=forests),data=c.mod2.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
#  geom_text(size=3,hjust = 0, nudge_y= 0.45, nudge_x = 0.0015)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y="Change in [MAOM C]\n along mycorrhizal gradient")+
  theme_cowplot()+
  ylim(-17, 17)+
  xlim(0.017, 0.057)+
  theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12), axis.title=element_text(size=13))

y=ggplot(aes(x=CDI, y=E, label=forests),data=n.mod1.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
  #geom_text(size=3,hjust = 0,nudge_y= -0.015, nudge_x = 0.0015)+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y=expression(atop("Change in proportion N"[MAOM],paste("along mycorrhizal gradient"))))+
  theme_cowplot()+
  ylim(-0.3, 0.3)+
  xlim(0.017, 0.057)+
 theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12),  axis.title=element_text(size=13))

z=ggplot(aes(x=CDI, y=E, label=forests),data=n.mod2.slopes)+
  geom_point(size=2.5)+
  geom_text_repel()+
  #geom_text(size=3,position=position_jitter(width=0.1, height=0.1))+
  geom_hline(yintercept=0, linetype="dashed")+
labs(x=" Climate Decomposition Index ", y="Change in [MAOM N]\n along mycorrhizal gradient")+
  theme_cowplot()+
  ylim(-1.6, 1.6)+
  xlim(0.017, 0.057)+
  theme(legend.title=element_blank(), legend.text=element_text(size=12), axis.text=element_text(size=12),  axis.title=element_text(size=13))

#hjust = 0,nudge_y= 0.15, nudge_x = 0.0005,

ggarrange(w,x,y,z, labels=c("a", "b", "c", "d"), nrow=2, ncol=2, legend=F)
ggsave("Fig2.jpg", path="figures/", width= 18, height= 16, units="cm")

```

```{r OLF_models, echo=F, message=F, warning=F, fig.width=11, fig.height=9}

propC.myc.olf=ggplot(final_data, aes(x=E*100, y=proportion.C_OLF))+
    geom_point(aes(color=Site))+
    scale_colour_viridis_d()+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
  labs(x=" % ECM basal area ", y=expression("proportion C"[oPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc.olf=ggplot(final_data, aes(x=E*100, y=mg.C.per.g.soil_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[oPOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc.olf=ggplot(final_data, aes(x=E*100, y=proportion.N_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y=expression("proportion N"[oPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concN.myc.olf=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_OLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[oPOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc.olf, propN.myc.olf, concC.myc.olf, concN.myc.olf, nrow=2, ncol=2, common.legend=T,legend = "right",labels=c("a", "b", "c", "d"))
ggsave("olf.cdi.plots.tiff",path="figures/", width= 24, height= 20, units="cm")


c.mod3=lmer(proportion.C_OLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

c.mod4=lmer(mg.C.per.g.soil_OLF ~  E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod3=lmer(proportion.N_OLF ~  E*CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod4=lmer(mg.N.per.g.soil_OLF ~  E*CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.mod3, c.mod4,  show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3,show.df=TRUE)
tab_model( n.mod3, n.mod4, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)
```


```{r FLF_models, echo=F, message=F, warning=F, fig.width=11, fig.height=9}

propC.myc.flf=ggplot(final_data, aes(x=E*100, y=proportion.C_FLF, color=Site))+
  geom_point(aes(color=Site))+
    scale_colour_viridis_d()+
geom_point(aes(color=Site))+
    scale_colour_viridis_d()+
   geom_smooth(method="lm",size=2, se=F, aes(colour=Site))+
  labs(x=" % ECM basal area ", y=expression("proportion C"[fPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


concC.myc.flf=ggplot(final_data, aes(x=E*100, y=mg.C.per.g.soil_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[fPOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

propN.myc.flf=ggplot(final_data, aes(x=E*100, y=proportion.N_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y=expression("proportion N"[fPOM]), colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))



concN.myc.flf=ggplot(final_data, aes(x=E*100, y=mg.N.per.g.soil_FLF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
#  scale_colour_manual(values=cdi_colors, labels =  c("TREE", "BART", "HARV", "SERC", "ORNL", "DELA", "LENO"))+
  labs(x=" % ECM basal area ", y="[fPOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(propC.myc.flf, propN.myc.flf, concC.myc.flf, concN.myc.flf, nrow=2, ncol=2, common.legend=T,legend = "right", labels=c("a", "b", "c", "d"))
ggsave("flf.cdi.plots.tiff",path="figures/", width= 24, height= 20, units="cm")


c.mod5=lmer(proportion.C_FLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

c.mod6=lmer(mg.C.per.g.soil_FLF ~  E+CDI+FeOx+(1|Site),
           data=final_data,na.action = na.omit)

n.mod5=lmer(proportion.N_FLF ~  E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

n.mod6=lmer(mg.N.per.g.soil_FLF ~ E+CDI+FeOx +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.mod5, c.mod6, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3,show.df=TRUE)
tab_model(n.mod5, n.mod6, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)
```

```{r proportion.figure, fig.width=14, fig.height=5}
ggarrange(propC.myc.flf, propC.myc.olf, propC.myc, nrow=1, ncol=3, common.legend=T, legend="right", labels=c("a", "b","c"))
ggsave("som.proportion.plots.jpg",path="figures/", width= 30, height= 10, units="cm")

```

```{r feox.figure,fig.width=9, fig.height=7}

concC.fe.hf=ggplot(final_data, aes(x=FeOx, y=mg.C.per.g.soil_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  geom_point()+
  labs(x=" % FeOx ", y="[MAOM C] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

concN.fe.hf=ggplot(final_data, aes(x=FeOx, y=mg.N.per.g.soil_HF, color=Site))+
   geom_smooth(method="lm",size=2, se=F)+
  geom_point()+
  labs(x=" % FeOx ", y="[MAOM N] (mg/g soil)", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(concC.fe.hf, concN.fe.hf, nrow=1, ncol=2, common.legend=T, legend="right", labels=c("a", "b"))
ggsave("hf.conc.fe.pdf",path="figures/", width= 20, height= 10, units="cm")

#what are the slopes of these lines?
fe_conchf_slopes_C=coef(lmList(mg.C.per.g.soil_HF~FeOx|Site , data = final_data))[2]
fe.mod1.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(fe_conchf_slopes_C$FeOx) %>% 
  summarize(mean_slope=mean(fe_conchf_slopes_C$FeOx))

fe_conchf_slopes_N=coef(lmList(mg.N.per.g.soil_HF~FeOx|Site , data = final_data))[2]
fe.mod2.slopes= as.data.frame(forests)%>% 
  arrange(forests) %>% 
  cbind(fe_conchf_slopes_N$FeOx) %>% 
  summarize(mean_slope=mean(fe_conchf_slopes_N$FeOx))

```


```{r cton, warning=F, echo=F, message=F, fig.width=11, fig.height=4}
ctoN.myc.flf=ggplot(final_data, aes(x=E*100, y=C.N_FLF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="fPOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d()+
#  ylim(8, 55)+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ctoN.myc.olf=ggplot(final_data, aes(x=E*100, y=C.N_OLF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="oPOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d()+
#  ylim(8, 55)+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ctoN.myc.hf=ggplot(final_data, aes(x=E*100, y=C.N_HF, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="MAOM C:N", colour="Site")+
  theme_cowplot()+
  scale_color_viridis_d()+
#  ylim(8, 55)+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


ggarrange(ctoN.myc.flf, ctoN.myc.olf, ctoN.myc.hf, nrow=1, ncol=3, common.legend=T,legend = "right", labels=c("a", "b", "c"))
ggsave("cn.myc.jpg",path="figures/", width= 30, height= 10, units="cm")

c.n.mod.flf=lmer(C.N_FLF ~ E*CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)

c.n.mod.olf=lmer(C.N_OLF ~  E*CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)

c.n.mod.hf=lmer(C.N_HF ~  E*CDI+FeOx  +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.n.mod.flf, c.n.mod.olf, c.n.mod.hf, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)



```

```{r cn_bulk, echo=F, message=F, fig.width=11, include=F}


#bulk C:N

ctoN.myc.bulk=ggplot(final_data, aes(x=E*100, y=meanCNratio, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="Bulk soil C:N", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ctoN.myc.bulk

c.n.mod.bulk=lmer(meanCNratio ~  E +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.n.mod.bulk, show.se = TRUE, show.ci = FALSE, show.std=TRUE, digits = 3, digits.re = 3)


cConc.myc.bulk=ggplot(final_data, aes(x=E*100, y=meanOrganicCarbonPercent, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="Bulk soil %C", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

nConc.myc.bulk=ggplot(final_data, aes(x=E*100, y=meanNitrogenPercent, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="Bulk soil %N", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggarrange(cConc.myc.bulk, nConc.myc.bulk, nrow=1, ncol=2, common.legend=T, legend = "right", labels=c("a", "b"))


c.conc.modbulk=lmer(meanOrganicCarbonPercent ~ E   +(1|Site),
           data=final_data,na.action = na.omit)

n.conc.modbulk=lmer(meanNitrogenPercent ~ E  +(1|Site),
           data=final_data,na.action = na.omit)


tab_model(c.conc.modbulk, n.conc.modbulk, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)

#Does organic horizon C:N track mycorrhizal dominance? Only have data from BART, HARV, and ORNL:
o_horiz_CN_myc=lmer(meanCNratio~E+ (1|Site), data=organic_horizon_chem[organic_horizon_chem$Site != "TREE",], na.action=na.omit)
summary(o_horiz_CN_myc)
tab_model(o_horiz_CN_myc)
o_horiz_CN_myc_fig=ggplot(organic_horizon_chem, aes(x=E*100, y=meanCNratio, colour=Site))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="Organic horizon C:N", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))



```

```{r basalarea_conc, fig.width=11, echo=F, message=F, warning=F}

c.conc.basalArea=lmer(mg.C.per.g.soil_HF ~ plotBA  +(1|Site),
           data=final_data,na.action = na.omit)

n.conc.basalArea=lmer(mg.N.per.g.soil_HF ~ plotBA  +(1|Site),
           data=final_data,na.action = na.omit)

tab_model(c.conc.basalArea, n.conc.basalArea, show.se = TRUE, show.std=TRUE, show.ci = FALSE, digits = 3, digits.re = 3)



```





# Correlations. 
```{r correlations, echo=F, message=F, warning=F}
library(corrplot)
corMat=final_data %>% 
  select(E, fractionAngiosperm,FeOx, CDI, plotBA)

M=cor(corMat)
corrplot(M, method="number", type="upper")


```





# Fraction modern has no relationship with soil, plant, or climate variables but is inherently different on a site-by-site basis. It also has no bearing on the concentration or proportion of MAOM C in the soil. This is interesting because we hypothesized there would be a connection between the concentration of C in the MAOM fraction and the age of that C (bigger pool, more buidling up= older C and smaller pool= more dynamic pool= younger C) but that does not seem to be the case!  :
```{r radiocarbon_model, echo=F, message=F, warning=F}

model.14C=lmer(d14C~FeOx+E*CDI+(E|Site),
            # + (1| Site),
             data=final_data,
             na.action = na.omit)

#FeOx+Site yeilds conditional r2 of 0.727
#E + SIte 0.673
#CDI + Site 0.718


tab_model(model.14C, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)

model.14C2=lmer(d14C~mg.C.per.g.soil_HF
             + (1| Site),
             data=final_data,
             na.action = na.omit)

model.14C3=lmer(d14C~proportion.C_HF
             + (1| Site),
             data=final_data,
             na.action = na.omit)

tab_model(model.14C2, model.14C3, show.se = TRUE, show.ci = FALSE, digits = 2, digits.re = 2, show.std = TRUE)


```

```{r radiocarbon_figs, echo=F, warning=F, message=F, fig.width=8}
ggplot(final_data[final_data$Site!= "ORNL",], aes(x=Site, y=d14C))+
   stat_summary(fun= mean, fun.min=mean, fun.max=mean, geom="crossbar", width=0.8, position="dodge")+
  stat_summary(fun.data = mean_se, geom = "errorbar", width=0.3, position = position_dodge(width = 0.8))+
  geom_hline(yintercept=0, linetype="dashed")+
  labs(y=expression(MAOM~delta^14*C))+
  geom_point()+
  theme_cowplot()

# y=expression(atop(Adjusted~soil~respiration~rate, paste("("*mu*mol~CO[2]~m^-2~s^-1*")"))))

ggsave("radiocarbon.FM.pdf",path="figures/", width= 14, height= 10, units="cm")

```



```{r bulk_isotopes, echo=F, message=F, warning=F, eval=F}
## We do have full data for bulk 13C and 15N in the soil samples that I fractionated. They both seem to (usually) increase with MAOM C and N concentration, and are not affected by ECM dominance.
ggplot(full_data_with_fractions, aes(x=mg.C.per.g.soil_HF, y=meanorganicd13C, colour=Site.x))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" mg C in MAOM per g soil ", y=" d13C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggplot(full_data_with_fractions, aes(x=mg.N.per.g.soil_HF, y=meand15N, colour=Site.x))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x="mg N in MAOM per g soil ", y="d15N ")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggplot(full_data_with_fractions, aes(x=E*100, y=meanorganicd13C, colour=Site.x))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y=" d13C")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

ggplot(full_data_with_fractions, aes(x=E*100, y=meand15N, colour=Site.x))+
   geom_smooth(method="lm",size=2, se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" % ECM basal area ", y="d15N ")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))




```

```{r microbes2, echo=F, message=F, warning=F, eval=F}
# Finally, the ratio of Fungi to Bactera/Archaea (ITS:16S gene copy number) is not affected by ECM dominance, and is not a good predictor of the proportion of MAOM C in our samples

# ggplot(full_data_with_fractions, aes(x=E*100, y=FB, colour=Site.x))+
#    geom_smooth(method="lm",size=2, se=F)+
#    geom_point(size=3, alpha=0.5)+
#   labs(x=" % ECM basal area ", y="F:B ")+
#   theme_cowplot()+
#   theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))


# 
# ggplot(full_data_with_fractions, aes(x=FB, y=proportion.C_HF, colour=Site.x))+
#    geom_smooth(method="lm",size=2, se=F)+
#    geom_point(size=3, alpha=0.5)+
#   labs(x=" F:B ", y="MAOM C (proportion) ")+
#   theme_cowplot()+
#   theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

# ggplot(full_data_with_fractions, aes(x=meanCopyNumBactArch, y=proportion.C_HF, colour=Site.x))+
#    geom_smooth(method="lm",size=2, se=F)+
#    geom_point(size=3, alpha=0.5)+
#   labs(x=" Fungal abundance ", y="MAOM C (proportion) ")+
#   theme_cowplot()+
#   theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))
# 
# ggplot(full_data_with_fractions[which(full_data_with_fractions$meanTotalLipidConcentration< 140),], aes(x=meanTotalLipidConcentration, y=proportion.C_HF, colour=Site.x))+
#    geom_smooth(method="lm",size=2, se=F)+
#    geom_point(size=3, alpha=0.5)+
#   labs(x=" Microbial biomass ", y="MAOM C (proportion) ")+
#   theme_cowplot()+
#   theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))

# HFC_micBiomass=lme(proportion.C_HF ~ meanTotalLipidConcentration, random=(~1|Site.x), data=full_data_with_fractions,na.action = na.omit)
# 
# summary(HFC_micBiomass)


  
```


```{r roots_litter_maom, echo=F, message=F, warning=F}

#Testing how root chem, litter chem influence MAOM [C] and [N] patterns at site level

#Litter Chemistry

#zipsByProduct(dpID="DP1.10033.001", site=c("BART",  "TREE", "HARV",  "ORNL", "DELA", "LENO", "SERC"), package="basic", savepath="data/")
#stackByTable(filepath="~/Documents/Projects/inProgress/MAOM_Postdoc/NEON_soil_data/data/filesToStack10033/", folder=T)

litter_chem=read.csv("data/filesToStack10033/stackedFiles/ltr_litterCarbonNitrogen.csv") %>%
  select(plotID, nitrogenPercent, carbonPercent, CNratio) %>%
  separate(plotID, into=c("Site", "plot"), sep="_", remove=F) %>% 
  group_by(Site) %>%
  summarise(meanlitterNitrogen=mean(nitrogenPercent[!is.na(nitrogenPercent)]),
            meanlitterCarbon=mean(carbonPercent[!is.na(carbonPercent)]),
            meanlitterCNratio=mean(CNratio[!is.na(CNratio)])) 


#root data
#zipsByProduct(dpID="DP1.10066.001", site=c("BART",  "TREE", "HARV",  "ORNL", "DELA", "LENO", "SERC"), package="basic", savepath="data/")
#stackByTable(filepath="~/Documents/Projects/inProgress/MAOM_Postdoc/NEON_soil_data/data/filesToStack10066/", folder=T)

root_chem=read.csv("data/filesToStack10066/stackedFiles/mpr_carbonNitrogen.csv") %>% 
  separate(cnSampleID, into=c("Site", "num", "topDepth","Status", "size"), extra="merge") %>% 
  mutate(topDepth=as.numeric(topDepth)) %>% 
  filter(topDepth<40) %>% 
  group_by(Site) %>% 
  summarise(mean_rootCN=mean(CNratio))

siteMeanMAOM=final_data %>% 
  select(Site, mg.C.per.g.soil_HF, proportion.C_HF, mg.N.per.g.soil_HF, proportion.N_HF) %>% 
  group_by(Site) %>% 
  summarise(mean_maom_c_conc=mean(mg.C.per.g.soil_HF),
         mean_maom_n_conc=mean(mg.N.per.g.soil_HF),
         mean_maom_prop_c=mean(proportion.C_HF),
         mean_maom_prop_n=mean(proportion.N_HF)) %>% 
 left_join(root_chem) %>% 
           left_join(litter_chem) %>% 
  rename("Roots"= mean_rootCN, "Leaf litter"="meanlitterCNratio") %>% 
  pivot_longer(cols=c("Roots", "Leaf litter"), names_to="tissue", values_to="CN") 

siteMeanMAOM_wide=final_data %>% 
  select(Site, mg.C.per.g.soil_HF, proportion.C_HF, mg.N.per.g.soil_HF, proportion.N_HF) %>% 
  group_by(Site) %>% 
  summarise(mean_maom_c_conc=mean(mg.C.per.g.soil_HF),
         mean_maom_n_conc=mean(mg.N.per.g.soil_HF),
         mean_maom_prop_c=mean(proportion.C_HF),
         mean_maom_prop_n=mean(proportion.N_HF)) %>% 
 left_join(root_chem) %>% 
           left_join(litter_chem) %>% 
  rename("Roots"= mean_rootCN, "Leaf litter"="meanlitterCNratio") 

MAOM_ROOTS_LITTER_Cconc=ggplot(siteMeanMAOM, aes(x=mean_maom_c_conc, y=CN), group=tissue)+
  geom_smooth( method="lm", aes(color=tissue))+
  geom_point( alpha=0.5, aes(color=tissue))+
  scale_color_manual(values=c("darkolivegreen4", "brown"))+
  theme_cowplot()+
  labs(x="MAOM [C] (mg/g soil)", y="Mean C:N")

MAOM_ROOTS_LITTER_Nconc=ggplot(siteMeanMAOM, aes(x=mean_maom_n_conc, y=CN), group=tissue)+
   geom_smooth( method="lm", aes(color=tissue))+
  geom_point( alpha=0.5, aes(color=tissue))+
  scale_color_manual(values=c("darkolivegreen4", "brown"))+
  theme_cowplot()+
  labs(x="MAOM [N] (mg/g soil)", y="Mean C:N")

MAOM_ROOTS_LITTER_Cprop=ggplot(siteMeanMAOM, aes(x=mean_maom_prop_c, y=CN), group=tissue)+
   geom_smooth( method="lm", aes(color=tissue))+
  geom_point( alpha=0.5, aes(color=tissue))+
  scale_color_manual(values=c("darkolivegreen4", "brown"))+
  theme_cowplot()+
  labs(x="f(MAOM) C", y="Mean C:N")

MAOM_ROOTS_LITTER_Nprop=ggplot(siteMeanMAOM, aes(x=mean_maom_prop_n, y=CN), group=tissue)+
   geom_smooth( method="lm", aes(color=tissue))+
  geom_point( alpha=0.5, aes(color=tissue))+
  scale_color_manual(values=c("darkolivegreen4", "brown"))+
  theme_cowplot()+
  labs(x="f(MAOM) N", y="Mean C:N")

roots_leaves_maom=ggarrange(MAOM_ROOTS_LITTER_Cconc, MAOM_ROOTS_LITTER_Cprop, MAOM_ROOTS_LITTER_Nconc, MAOM_ROOTS_LITTER_Nprop, nrow=2, ncol=2, common.legend = T, legend="right")
ggsave("roots_leaves_maom.jpg", path="figures/", width= 16, height= 12, units="cm")


# summary(lm(mean_maom_c_conc ~ `Leaf litter`, data=siteMeanMAOM_wide))
# summary(lm(mean_maom_n_conc ~ `Leaf litter`, data=siteMeanMAOM_wide))
# summary(lm(mean_maom_prop_c ~ `Leaf litter`, data=siteMeanMAOM_wide))
# summary(lm(mean_maom_prop_n ~ `Leaf litter`, data=siteMeanMAOM_wide))
```


```{r neon_ecm_v_litter, echo=F}


plot_trees_all=plot_trees_a %>% 
  filter(speciesDominance>5) %>% 
  dplyr::group_by(plotID, mycType) %>% 
  mutate(totalBAbyMyc=sum(sumBA)) %>% 
  dplyr::summarise(myc.dominance=(totalBAbyMyc/totalBAbyPlot), plotBA=mean(totalBAbyPlot)) %>%
  separate(plotID, into=c("Site", "Plot"), sep="_", remove=F) %>%
  distinct() %>% 
  pivot_wider(values_from=myc.dominance, names_from=mycType) %>%
  replace_na(list(E=0, A=0, B=0, ER=0)) 


litter_chem_plots=read.csv("data/filesToStack10033/stackedFiles/ltr_litterCarbonNitrogen.csv") %>%
  select(plotID, nitrogenPercent, carbonPercent, CNratio) %>% 
  drop_na(CNratio) %>% 
  left_join(plot_trees_all, (by="plotID"))%>% 
  drop_na() %>% 
  separate(plotID, into=c("Site", "plot"), sep="_")

ggplot(litter_chem_plots, aes(x=E*100, y=CNratio, color=Site))+
         geom_smooth(method="lm", size=2,se=F)+
   geom_point(size=3, alpha=0.5)+
  labs(x=" ECM dominance ", y="Aboveground litter C:N", colour="Site")+
  theme_cowplot()+
  theme(legend.title=element_text(hjust=0.5, size=16), legend.text=element_text(size=15), axis.text=element_text(size=15), axis.title=element_text(size=19))
ggsave("litter.chem.ecm.tiff", path="figures/", width= 16, height= 12, units="cm")

litter_chem_ecm=lmer(CNratio~E+(1|Site),
           data=litter_chem_plots,na.action = na.omit)
  tab_model(litter_chem_ecm, show.std=TRUE, show.se = TRUE, show.ci = FALSE, digits = 3, digits.re = 3)



```




